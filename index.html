<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ‰¶åŠ©æ¸¬é©—ç³»çµ± v18.0 (çœç´™åˆ—å°ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; margin: 0; background-color: #f4f4f4; }
        
        /* --- é¡è‰²å®šç¾© (çµ±è¨ˆç”¨) --- */
        .stat-chi { color: #cc0000; font-weight: bold; }
        .stat-math { color: #00008B; font-weight: bold; }
        .stat-eng { color: #006400; font-weight: bold; }
        .stat-total-row { background-color: #f0f0f0; font-weight: bold; border-top: 2px solid #666; }
        .stat-student-count { font-weight: bold; color: #333; background-color: #e8f0fe; }

        /* --- åˆ—å°å°ˆç”¨è¨­å®š --- */
        @media print {
            @page { margin: 5mm; size: A4 portrait; }
            
            /* å¼·åˆ¶éš±è—æ‰€æœ‰éåˆ—å°å…ƒç´  */
            .navbar, .settings-box, .nav-buttons, .print-mode-selector, .btn, .filter-bar, h3, p, .hint-text, label, .class-selector-container, .btn-group, .config-row { 
                display: none !important; 
            }
            
            body { background: white; margin: 0; padding: 0; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; width: 100%; }
            
            /* æ§åˆ¶åªé¡¯ç¤ºç•¶å‰è¦å°çš„å€åŸŸ */
            #print-section-slips, #print-section-list, #print-section-stats, #print-section-teachers { display: none; }
            
            /* é¡¯ç¤ºå°æ‡‰å€å¡Š */
            body.print-slips #print-section-slips { display: block !important; }
            body.print-list #print-section-list { display: block !important; }
            body.print-stats #print-section-stats { display: block !important; }
            
            /* å°å¸«åå–® - å…©ç¨®æ¨¡å¼å…±ç”¨é¡¯ç¤º */
            body.print-teachers #print-section-teachers,
            body.print-teachers-compact #print-section-teachers { display: block !important; }
            
            /* --- æ¨¡å¼ A: å°å¸«åå–® (åˆ†é ) --- */
            body.print-teachers .page-break { 
                page-break-after: always; 
                display: block; 
                height: 0; 
            }

            /* --- æ¨¡å¼ B: å°å¸«åå–® (ä¸åˆ†é /çœç´™) --- */
            body.print-teachers-compact .teacher-block {
                page-break-inside: avoid; /* ç›¡é‡ä¸è¦æŠŠä¸€å€‹ç­åˆ‡å…©åŠ */
                margin-bottom: 5px;
            }
            
            body.print-teachers-compact .page-break { 
                page-break-after: auto; /* å–æ¶ˆå¼·åˆ¶æ›é  */
                display: block;
                border-bottom: 2px dashed #999; /* è™›ç·šè£åˆ‡ç·š */
                margin: 25px 0 25px 0; /* ä¸Šä¸‹ç•™ç™½ */
                height: 1px;
                position: relative;
            }

            /* åŠ å…¥è£åˆ‡ç·šæ–‡å­— */
            body.print-teachers-compact .page-break::after {
                content: "âœ‚ï¸ è£åˆ‡ç·š";
                position: absolute;
                left: 50%;
                top: -12px;
                transform: translateX(-50%);
                background: white;
                padding: 0 10px;
                color: #666;
                font-size: 10pt;
            }
            
            /* éš±è—æœ€å¾Œä¸€å€‹è£åˆ‡ç·š (ç¾è§€) */
            body.print-teachers-compact .page-break:last-child {
                display: none;
            }

            /* è¡¨æ ¼åˆ—å°å„ªåŒ– */
            table { width: 100% !important; margin: 0 auto; page-break-inside: avoid; margin-bottom: 20px; }
            th, td { padding: 4px; }
            
            /* å°å¸«åå–®å°ˆç”¨ç¸®å°å­—é«” */
            .teacher-table th, .teacher-table td { font-size: 9pt !important; padding: 2px 4px !important; }
            .teacher-header { font-size: 14pt !important; }
        }

        /* --- ä»‹é¢æ¨£å¼ --- */
        .navbar {
            background-color: #2c3e50; color: white; padding: 15px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        .nav-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .container {
            max-width: 1100px; margin: 20px auto; padding: 20px;
            background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .settings-box {
            border: 2px solid #e0e0e0; padding: 20px; margin-bottom: 20px;
            background-color: #fff; border-radius: 8px;
        }
        .config-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; flex-wrap: wrap; }
        .config-row label { font-weight: bold; width: 60px; flex-shrink: 0; }
        input[type="text"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* é‡å°åˆ†ç§‘æ™‚é–“è¨­å®šçš„æ¨£å¼ */
        .subject-group { 
            display: flex; flex-direction: column; gap: 5px; 
            border-left: 3px solid #ccc; padding-left: 10px; margin-right: 15px;
        }
        .subject-group.chi { border-left-color: #cc0000; }
        .subject-group.math { border-left-color: #00008B; }
        .subject-group.eng { border-left-color: #006400; }
        
        .time-row { display: flex; align-items: center; gap: 5px; }
        .time-label { font-size: 14px; font-weight: bold; width: 40px; }
        
        /* è¼¸å…¥æ¡†å¯¬åº¦èª¿æ•´ */
        .input-time { width: 160px; }
        .input-loc { width: 120px; }

        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; font-size: 14px; }
        .btn-blue { background-color: #3498db; } .btn-blue:hover { background-color: #2980b9; }
        .btn-green { background-color: #27ae60; } .btn-green:hover { background-color: #219150; }
        .btn-gray { background-color: #95a5a6; }
        .btn.active { background-color: #f39c12; border: 2px solid #e67e22; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- æ¸¬é©—é€šçŸ¥å–® (Slip) --- */
        .slip-container {
            width: 19.8cm; margin: 0 auto 15px auto; background: white; padding: 2px 0;
            border-bottom: 1px dashed #bbb; page-break-inside: avoid;
        }
        .slip-header { text-align: center; font-size: 20px; font-weight: bold; font-family: "æ¨™æ¥·é«”"; margin-bottom: 3px; }
        table.slip-table { width: 100%; border-collapse: collapse; border: 2px solid black; font-family: "æ¨™æ¥·é«”"; text-align: center; table-layout: fixed; }
        .slip-table th, .slip-table td { border: 1px solid black; padding: 4px; font-size: 18px; vertical-align: middle; word-wrap: break-word; }
        .slip-table th { height: 35px; background: #fff; font-weight: normal; font-size: 16px; }
        .slip-table td { height: 75px; }
        .text-red { color: red !important; font-weight: bold; font-family: "Microsoft JhengHei"; }
        .text-left-content { text-align: left; padding-left: 10px !important; }
        .text-center-content { text-align: center; } 
        .square { display: inline-block; width: 14px; height: 14px; margin-right: 3px; vertical-align: middle; font-size: 16px; }
        .items-cell div { white-space: nowrap; }
        .items-note { font-size: 13px; margin: 0; display: block; white-space: nowrap; }

        /* --- é€šç”¨è¡¨æ ¼ --- */
        table.list-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 14px; color: #333; margin-bottom: 20px;}
        table.list-table th { background-color: #f2f2f2; border: 1px solid #999; padding: 8px; font-weight: bold; white-space: nowrap; }
        table.list-table td { border: 1px solid #999; padding: 6px; vertical-align: middle; text-align: center; }
        .col-left { text-align: left; padding-left: 10px !important; }

        /* --- å°å¸«åå–®å°ˆç”¨è¡¨æ ¼ --- */
        table.teacher-table { width: 100%; border-collapse: collapse; font-size: 10pt; color: #000; margin-bottom: 0; }
        table.teacher-table th { background-color: #e0e0e0; border: 1px solid #666; padding: 4px; text-align: center; font-weight: bold; }
        table.teacher-table td { border: 1px solid #666; padding: 4px; text-align: center; vertical-align: middle; }
        .info-cell { font-size: 9pt; color: #444; }
        
        .teacher-header { 
            background-color: #333; color: white; padding: 8px 15px; margin-top: 0; 
            border-radius: 0; text-align: center; font-weight: bold; font-size: 14pt; 
            border: 1px solid #000; border-bottom: none; 
            -webkit-print-color-adjust: exact;
            display: flex; justify-content: space-between; align-items: center;
        }

        .print-mode-selector { background-color: #fff8e1; border: 2px solid #ffe082; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        .print-mode-selector label { margin: 0 15px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .print-mode-selector input { transform: scale(1.3); margin-right: 5px; }

        /* å°å¸«é¸å–® */
        .class-selector-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .grade-group-card { border: 1px solid #ccc; border-radius: 5px; padding: 10px; background-color: #f9f9f9; }
        .grade-group-header { font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .class-checkbox-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .class-checkbox-item { display: flex; align-items: center; background: #fff; border: 1px solid #ddd; padding: 4px 8px; border-radius: 4px; font-size: 14px; }

    </style>
</head>
<body>

    <div class="navbar">
        <h2 style="margin:0; margin-right: 20px;">æ¸¬é©—ç³»çµ± v18.0</h2>
        <div class="nav-buttons">
            <button class="btn btn-gray active" onclick="switchTab('data')">1. è³‡æ–™åŒ¯å…¥</button>
            <button class="btn btn-gray" onclick="switchTab('slips')">2. é€šçŸ¥å–®</button>
            <button class="btn btn-gray" onclick="switchTab('idlist')">3. ç°½åˆ°è¡¨</button>
            <button class="btn btn-gray" onclick="switchTab('stats')">4. çµ±è¨ˆå ±è¡¨</button>
            <button class="btn btn-gray" onclick="switchTab('teachers')">5. å°å¸«ç•™å­˜åå–®</button>
        </div>
    </div>

    <div class="container">
        
        <div id="tab-data" class="tab-content active">
            <div class="settings-box">
                <h3>æ­¥é©Ÿä¸€ï¼šåŒ¯å…¥ Excel æª”æ¡ˆ</h3>
                <input type="file" id="uploadFile" accept=".csv, .xlsx, .xls" />
                <p class="hint-text" style="color:#666; font-size:14px; margin-top:10px; line-height: 1.6;">
                    Excel å»ºè­°åŒ…å«æ¬„ä½ï¼š<br>
                    <b>ç›®å‰å¹´ç´šã€ç­ç´šã€åº§è™Ÿã€å§“åã€èº«åˆ†è­‰çµ±ä¸€ç·¨è™Ÿã€åœ‹èªæ–‡æ¸¬é©—ã€æ•¸å­¸æ¸¬é©—ã€è‹±èªæ¸¬é©—</b>
                </p>
            </div>
            <div id="data-preview-msg"></div>
        </div>

        <div id="tab-slips" class="tab-content">
            <div class="settings-box">
                <h3>æ­¥é©ŸäºŒï¼šè¨­å®šæ¸¬é©—è³‡è¨Š (ç§‘ç›®/æ™‚é–“/åœ°é»)</h3>
                <p style="color:#666; font-size:13px; margin-top:-10px;">(ç³»çµ±æœƒè‡ªå‹•è¨˜æ†¶æ‚¨è¼¸å…¥çš„å…§å®¹)</p>
                <div class="config-row" style="background-color: #e8f4fd; border: 1px solid #b6e0fe; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <label style="width: 80px;">é€šçŸ¥å–®æ¨™é¡Œ</label>
                    <input type="text" id="slip-title-input" onchange="saveConfig()" value="æ•™è‚²éƒ¨-æ–°èŠåœ‹å°-å­¸ç¿’æ‰¶åŠ©-æˆé•·æ¸¬é©— (è«‹å”åŠ©è²¼æ–½æ¸¬ç•¶é€±è¯çµ¡ç°¿)" style="width: 100%; font-weight: bold;">
                </div>
                <div id="grade-settings"></div>
            </div>

            <div class="print-mode-selector">
                <div style="margin-bottom:10px; color:#d35400;">ğŸ–¨ï¸ <b>é¸æ“‡è¦ç”¢ç”Ÿçš„é€šçŸ¥å–®ç§‘ç›®ï¼š</b></div>
                <label><input type="checkbox" id="p-chi" checked onchange="refreshSlips()"> åœ‹èª</label>
                <label><input type="checkbox" id="p-math" onchange="refreshSlips()"> æ•¸å­¸</label>
                <label><input type="checkbox" id="p-eng" onchange="refreshSlips()"> è‹±èª</label>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-green" onclick="printArea('slips')">ğŸ–¨ï¸ åˆ—å°é€šçŸ¥å–®</button>
            </div>
            <div id="print-section-slips"></div>
        </div>

        <div id="tab-idlist" class="tab-content">
            <div class="settings-box">
                <h3>æ­¥é©Ÿä¸‰ï¼šæ¸¬é©—ç°½åˆ°èˆ‡èº«åˆ†è­‰æ ¸å°è¡¨</h3>
                <div class="print-mode-selector">
                    <span style="font-weight:bold; margin-right:10px;">è«‹é¸æ“‡åˆ—å°æ¨¡å¼ï¼š</span>
                    <label><input type="radio" name="signMode" value="all" checked onchange="generateIDList()"> ç¸½è¡¨(å«æ‰€æœ‰ç§‘ç›®)</label>
                    <label><input type="radio" name="signMode" value="chi" onchange="generateIDList()"> åœ‹èªå°ˆç”¨</label>
                    <label><input type="radio" name="signMode" value="math" onchange="generateIDList()"> æ•¸å­¸å°ˆç”¨</label>
                    <label><input type="radio" name="signMode" value="eng" onchange="generateIDList()"> è‹±èªå°ˆç”¨</label>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-green" onclick="printArea('list')">ğŸ–¨ï¸ åˆ—å°ç°½åˆ°è¡¨</button>
                </div>
            </div>
            <div id="print-section-list"></div>
        </div>

        <div id="tab-stats" class="tab-content">
            <div class="settings-box" style="display:flex; justify-content:space-between; align-items:center;">
                <h3>æ­¥é©Ÿå››ï¼šçµ±è¨ˆå ±è¡¨ä¸­å¿ƒ</h3>
                <button class="btn btn-green" onclick="printArea('stats')">ğŸ–¨ï¸ åˆ—å°çµ±è¨ˆç¸½è¡¨</button>
            </div>
            <div id="print-section-stats"></div>
        </div>

        <div id="tab-teachers" class="tab-content">
            <div class="settings-box">
                <h3>æ­¥é©Ÿäº”ï¼šå°å¸«ç•™å­˜åå–® (å«å„ç§‘æ™‚é–“åœ°é»)</h3>
                <p style="margin:5px 0;">è«‹å‹¾é¸è¦åˆ—å°çš„ç­ç´š (åˆ—å°æ™‚ï¼Œæ¯å€‹ç­ç´šæœƒè‡ªå‹•æ›é )ï¼š</p>
                <div style="margin:10px 0;" class="btn-group">
                     <button class="btn btn-blue" onclick="toggleAllGrades(true)">å…¨æ ¡å…¨é¸</button>
                     <button class="btn btn-gray" onclick="toggleAllGrades(false)">å…¨éƒ¨å–æ¶ˆ</button>
                </div>
                <div id="class-selector-container" class="class-selector-container"></div>
                <div style="text-align: center; margin-top:20px; padding-top:10px; border-top:1px solid #eee;">
                    <button class="btn btn-green" onclick="generateTeacherLists()">ğŸ”„ ç”¢ç”Ÿåå–®</button>
                    <button class="btn btn-green" onclick="printArea('teachers')">ğŸ–¨ï¸ åˆ—å° (åˆ†é )</button>
                    <button class="btn btn-blue" onclick="printArea('teachers-compact')">âœ‚ï¸ åˆ—å° (ä¸åˆ†é /çœç´™)</button>
                </div>
            </div>
            <div id="print-section-teachers"></div>
        </div>

    </div>

<script>
    let globalStudents = [];

    // --- æœ¬åœ°å„²å­˜ (Local Storage) åŠŸèƒ½ ---
    function saveConfig() {
        const config = {
            title: document.getElementById('slip-title-input').value,
            grades: {}
        };
        for (let i = 1; i <= 6; i++) {
            config.grades[i] = {
                dateC: document.getElementById(`date-c-${i}`).value,
                locC: document.getElementById(`loc-c-${i}`).value,
                dateM: document.getElementById(`date-m-${i}`).value,
                locM: document.getElementById(`loc-m-${i}`).value,
                dateE: document.getElementById(`date-e-${i}`).value,
                locE: document.getElementById(`loc-e-${i}`).value
            };
        }
        localStorage.setItem('examSystemConfig_v14', JSON.stringify(config));
    }

    function loadConfig() {
        const saved = localStorage.getItem('examSystemConfig_v14');
        if (saved) {
            const config = JSON.parse(saved);
            if(config.title) document.getElementById('slip-title-input').value = config.title;
            if(config.grades) {
                for (let i = 1; i <= 6; i++) {
                    if(config.grades[i]) {
                        if(document.getElementById(`date-c-${i}`)) document.getElementById(`date-c-${i}`).value = config.grades[i].dateC;
                        if(document.getElementById(`loc-c-${i}`)) document.getElementById(`loc-c-${i}`).value = config.grades[i].locC;
                        if(document.getElementById(`date-m-${i}`)) document.getElementById(`date-m-${i}`).value = config.grades[i].dateM;
                        if(document.getElementById(`loc-m-${i}`)) document.getElementById(`loc-m-${i}`).value = config.grades[i].locM;
                        if(document.getElementById(`date-e-${i}`)) document.getElementById(`date-e-${i}`).value = config.grades[i].dateE;
                        if(document.getElementById(`loc-e-${i}`)) document.getElementById(`loc-e-${i}`).value = config.grades[i].locE;
                    }
                }
            }
        }
    }

    // åˆå§‹åŒ–å¹´ç´šè¨­å®š
    const gradeSettingsContainer = document.getElementById('grade-settings');
    for (let i = 1; i <= 6; i++) {
        const div = document.createElement('div');
        div.className = 'config-row';
        let defaultTime = `12/${i}(ä¸€) 07:50~08:30`;
        div.innerHTML = `
            <label>${i} å¹´ç´š</label>
            <div style="flex:1; display:flex; flex-wrap:wrap;">
                <div class="subject-group chi">
                    <span class="time-label" style="color:#cc0000;">åœ‹èª</span>
                    <div class="time-row">
                        <input type="text" id="date-c-${i}" class="input-time" placeholder="æ™‚é–“" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="loc-c-${i}" class="input-loc" placeholder="åœ°é»" value="${i}F æ•™å®¤" onchange="saveConfig()">
                    </div>
                </div>
                <div class="subject-group math">
                    <span class="time-label" style="color:#00008B;">æ•¸å­¸</span>
                    <div class="time-row">
                        <input type="text" id="date-m-${i}" class="input-time" placeholder="æ™‚é–“" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="loc-m-${i}" class="input-loc" placeholder="åœ°é»" value="${i}F æ•™å®¤" onchange="saveConfig()">
                    </div>
                </div>
                <div class="subject-group eng">
                    <span class="time-label" style="color:#006400;">è‹±èª</span>
                    <div class="time-row">
                        <input type="text" id="date-e-${i}" class="input-time" placeholder="æ™‚é–“" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="loc-e-${i}" class="input-loc" placeholder="åœ°é»" value="${i}F æ•™å®¤" onchange="saveConfig()">
                    </div>
                </div>
            </div>
        `;
        gradeSettingsContainer.appendChild(div);
    }
    
    loadConfig();

    // åŒ¯å…¥ Excel
    document.getElementById('uploadFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            
            // è³‡æ–™å°æ‡‰ (v17.0 ä¿®æ­£åˆ¤æ–·é‚è¼¯)
            globalStudents = rawData.map((row, index) => {
                // è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥æ˜¯å¦ç‚º X
                const checkExam = (val) => {
                    if (!val) return false;
                    const str = val.toString().trim().toUpperCase();
                    // åªè¦åŒ…å« X å°±è¦–ç‚ºè¦è€ƒ (ç›¸å®¹å…¨å½¢ï¼¸)
                    return str.includes('X') || str.includes('ï¼¸');
                };

                // è¼”åŠ©å‡½å¼ï¼šæª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™ (åŒ…å« X æˆ– O)
                const checkCase = (val) => {
                    if (!val) return false;
                    const str = val.toString().trim();
                    return str.length > 0;
                };

                const rawChi = row['åœ‹èªæ–‡æ¸¬é©—'] || row['åœ‹èª'];
                const rawMath = row['æ•¸å­¸æ¸¬é©—'] || row['æ•¸å­¸'];
                const rawEng = row['è‹±èªæ¸¬é©—'] || row['è‹±èª'];

                return {
                    id: index + 1,
                    grade: (row['ç›®å‰å¹´ç´š'] || row['å¹´ç´š'] || '').toString().trim(),
                    cls: (row['ç­ç´š'] || '').toString().trim(),
                    seat: (row['åº§è™Ÿ'] || '').toString().trim(), 
                    name: (row['å§“å'] || '').toString().trim(),
                    idNo: (row['èº«åˆ†è­‰çµ±ä¸€ç·¨è™Ÿ'] || row['èº«åˆ†è­‰'] || row['èº«åˆ†è­‰å­—è™Ÿ'] || '').toString().trim(),
                    
                    // è€ƒè©¦åˆ¤å®šï¼šåªæœ‰ X æ‰ç®—
                    chi: checkExam(rawChi),
                    math: checkExam(rawMath),
                    eng: checkExam(rawEng),

                    // å€‹æ¡ˆåˆ¤å®šï¼šæœ‰è³‡æ–™å°±ç®— (X æˆ– O)
                    isCase: checkCase(rawChi) || checkCase(rawMath) || checkCase(rawEng)
                };
            });

            // æ’åº
            globalStudents.sort((a, b) => {
                if (a.grade !== b.grade) return parseInt(a.grade) - parseInt(b.grade);
                if (a.cls !== b.cls) return parseInt(a.cls) - parseInt(b.cls);
                return (parseInt(a.seat) || 0) - (parseInt(b.seat) || 0);
            });

            document.getElementById('data-preview-msg').innerHTML = 
                `<p style="color:green; text-align:center;">âœ… æˆåŠŸåŒ¯å…¥ ${globalStudents.length} ç­†è³‡æ–™ï¼</p>`;
            
            generateIDList();
            generateStats();
            initTeacherClassSelector();
            refreshSlips();
            switchTab('slips'); 
        };
        reader.readAsArrayBuffer(file);
    });

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-buttons button').forEach(el => el.classList.remove('active'));
        const tabMap = { 'data': 0, 'slips': 1, 'idlist': 2, 'stats': 3, 'teachers': 4 };
        document.getElementById('tab-' + tabName).classList.add('active');
        document.querySelectorAll('.nav-buttons button')[tabMap[tabName]].classList.add('active');
        if(tabName === 'slips') refreshSlips();
        if(tabName === 'idlist') generateIDList();
        if(tabName === 'stats') generateStats();
    }

    // --- åŠŸèƒ½ 1ï¼šæ¸¬é©—é€šçŸ¥å–® (åªå°æœ‰Xçš„) ---
    function refreshSlips() {
        const container = document.getElementById('print-section-slips');
        container.innerHTML = '';
        const currentTitle = document.getElementById('slip-title-input').value;
        if (globalStudents.length === 0) return;

        const printTargets = [];
        if (document.getElementById('p-chi').checked) printTargets.push('chi');
        if (document.getElementById('p-math').checked) printTargets.push('math');
        if (document.getElementById('p-eng').checked) printTargets.push('eng');

        if (printTargets.length === 0) { container.innerHTML = '<p style="text-align:center;color:red;">è«‹è‡³å°‘å‹¾é¸ä¸€ç¨®ç§‘ç›®</p>'; return; }

        printTargets.forEach(subjectType => {
            globalStudents.forEach(s => {
                // åªæœ‰è¦è€ƒè©²ç§‘çš„äººæ‰å°
                let hasSubject = false;
                if (subjectType === 'chi' && s.chi) hasSubject = true;
                if (subjectType === 'math' && s.math) hasSubject = true;
                if (subjectType === 'eng' && s.eng) hasSubject = true;
                if (!hasSubject) return;

                const tickChi = (subjectType === 'chi');
                const tickMath = (subjectType === 'math');
                const tickEng = (subjectType === 'eng');
                const tickPencil = true; 
                const tickHeadphone = (subjectType === 'eng');
                
                let dateTime = "";
                let location = "";

                if (subjectType === 'chi') {
                    dateTime = document.getElementById(`date-c-${s.grade}`).value;
                    location = document.getElementById(`loc-c-${s.grade}`).value;
                } else if (subjectType === 'math') {
                    dateTime = document.getElementById(`date-m-${s.grade}`).value;
                    location = document.getElementById(`loc-m-${s.grade}`).value;
                } else if (subjectType === 'eng') {
                    dateTime = document.getElementById(`date-e-${s.grade}`).value;
                    location = document.getElementById(`loc-e-${s.grade}`).value;
                }

                if(dateTime.includes(" ")) dateTime = dateTime.replace(" ", "<br>"); 

                const html = `
                    <div class="slip-container">
                        <div class="slip-header">${currentTitle}</div>
                        <table class="slip-table">
                            <colgroup>
                                <col style="width: 6%;">  
                                <col style="width: 6%;">  
                                <col style="width: 10%;"> 
                                <col style="width: 18%;"> 
                                <col style="width: 18%;"> 
                                <col style="width: 12%;"> 
                                <col style="width: 30%;"> 
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>å¹´ç´š</th><th>ç­ç´š</th><th>å§“å</th>
                                    <th>æ–½æ¸¬åœ°é»</th><th>æ–½æ¸¬æ—¥æœŸèˆ‡æ™‚é–“</th>
                                    <th>æ¸¬é©—ç§‘ç›®</th><th>å»ºè­°æ”œå¸¶ç‰©å“</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${s.grade}</td><td>${s.cls}</td><td>${s.name}</td>
                                    <td class="text-red">${location}</td><td class="text-red" style="line-height:1.4">${dateTime}</td>
                                    <td class="text-left-content">
                                        <div><span class="square">${tickChi ? 'â– ' : 'â–¡'}</span>åœ‹èª</div>
                                        <div><span class="square">${tickMath ? 'â– ' : 'â–¡'}</span>æ•¸å­¸</div>
                                        <div><span class="square">${tickEng ? 'â– ' : 'â–¡'}</span>è‹±èª</div>
                                    </td>
                                    <td class="text-center-content items-cell">
                                        <div><span class="square">${tickPencil ? 'â– ' : 'â–¡'}</span>é‰›ç­†ç›’</div>
                                        <div><span class="square">${tickHeadphone ? 'â– ' : 'â–¡'}</span>è‹±è½ç”¨è€³æ©Ÿ</div>
                                        <span class="items-note">(å¦‚æœæœ‰,æ¯”è¼ƒè¡›ç”Ÿ)</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        });
    }

    // --- åŠŸèƒ½ 2ï¼šèº«åˆ†è­‰ç°½åˆ°è¡¨ (åªåˆ—æœ‰Xçš„) ---
    function generateIDList() {
        const container = document.getElementById('print-section-list');
        if (globalStudents.length === 0) { container.innerHTML = '<p style="text-align:center;">è«‹å…ˆåŒ¯å…¥è³‡æ–™</p>'; return; }
        const mode = document.querySelector('input[name="signMode"]:checked').value;
        let titleSuffix = "";
        let showChi = true, showMath = true, showEng = true;
        if (mode === 'chi') { titleSuffix = "- åœ‹èªæ¸¬é©—å°ˆç”¨"; showMath = false; showEng = false; }
        else if (mode === 'math') { titleSuffix = "- æ•¸å­¸æ¸¬é©—å°ˆç”¨"; showChi = false; showEng = false; }
        else if (mode === 'eng') { titleSuffix = "- è‹±èªæ¸¬é©—å°ˆç”¨"; showChi = false; showMath = false; }
        
        // éæ¿¾ï¼šåªåˆ—å‡ºåœ¨ç•¶å‰æ¨¡å¼ä¸‹æœ‰è€ƒè©¦(X)çš„å­¸ç”Ÿ
        const studentsToShow = globalStudents.filter(s => {
            if (mode === 'all') return s.chi || s.math || s.eng;
            if (mode === 'chi') return s.chi;
            if (mode === 'math') return s.math;
            if (mode === 'eng') return s.eng;
        });

        let html = `
            <div style="text-align:center; margin-bottom:15px;">
                <h2>å­¸ç¿’æ‰¶åŠ©æˆé•·æ¸¬é©— - è€ƒç”Ÿèº«åˆ†è­‰å°ç…§è¡¨ ${titleSuffix}</h2>
            </div>
            <table class="list-table">
                <thead>
                    <tr>
                        <th style="width:40px;">åºè™Ÿ</th><th style="width:50px;">å¹´ç´š</th><th style="width:50px;">ç­ç´š</th><th style="width:50px;">åº§è™Ÿ</th>
                        <th style="width:100px; text-align:left; padding-left:10px;">å§“å</th>
                        <th style="width:120px; text-align:left; padding-left:10px;">èº«åˆ†è­‰çµ±ä¸€ç·¨è™Ÿ</th>
                        ${showChi ? '<th style="width:40px;">åœ‹èª</th>' : ''}
                        ${showMath ? '<th style="width:40px;">æ•¸å­¸</th>' : ''}
                        ${showEng ? '<th style="width:40px;">è‹±èª</th>' : ''}
                        <th style="width:80px;">å ±åˆ°æ‰“å‹¾</th>
                    </tr>
                </thead>
                <tbody>`;
        studentsToShow.forEach((s, idx) => {
            html += `<tr>
                <td>${idx + 1}</td><td>${s.grade}</td><td>${s.cls}</td><td>${s.seat}</td>
                <td class="col-left">${s.name}</td>
                <td class="col-left" style="font-family:monospace; font-size:15px;">${s.idNo}</td>
                ${showChi ? `<td>${s.chi ? 'â—' : ''}</td>` : ''}
                ${showMath ? `<td>${s.math ? 'â—' : ''}</td>` : ''}
                ${showEng ? `<td>${s.eng ? 'â—' : ''}</td>` : ''}
                <td><span style="font-size:20px;">â–¡</span></td>
            </tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // --- åŠŸèƒ½ 3ï¼šçµ±è¨ˆå ±è¡¨ (v17.0 ä¿®æ­£çµ±è¨ˆé‚è¼¯) ---
    function generateStats() {
        const container = document.getElementById('print-section-stats');
        if (globalStudents.length === 0) { container.innerHTML = '<p style="text-align:center;">è«‹å…ˆåŒ¯å…¥è³‡æ–™</p>'; return; }
        const gradeStats = {};
        const detailStats = {}; 
        
        let totalChi = 0, totalMath = 0, totalEng = 0;
        let totalStudents = 0; 

        globalStudents.forEach(s => {
            // çµ±è¨ˆåˆå§‹åŒ–
            if (!gradeStats[s.grade]) gradeStats[s.grade] = { c:0, m:0, e:0, studentCount: 0 };
            if (!detailStats[s.grade]) detailStats[s.grade] = {};
            if (!detailStats[s.grade][s.cls]) detailStats[s.grade][s.cls] = { c:0, m:0, e:0 };

            // è€ƒè©¦äººæ•¸çµ±è¨ˆï¼šåªç®—æœ‰ X çš„
            if(s.chi) { gradeStats[s.grade].c++; detailStats[s.grade][s.cls].c++; }
            if(s.math) { gradeStats[s.grade].m++; detailStats[s.grade][s.cls].m++; }
            if(s.eng) { gradeStats[s.grade].e++; detailStats[s.grade][s.cls].e++; }
            
            // å€‹æ¡ˆå­¸ç”Ÿçµ±è¨ˆï¼šç®— X + O (åªè¦ isCase ç‚ºçœŸ)
            if(s.isCase) {
                gradeStats[s.grade].studentCount++;
            }
        });

        let html = `<h3>(1) å…¨æ ¡å„å¹´ç´šæ‡‰è€ƒäººæ•¸ç¸½è¡¨</h3>
                    <table class="list-table" style="width:650px; margin:0 auto;">
                        <thead><tr><th>å¹´ç´š</th><th>å€‹æ¡ˆå­¸ç”Ÿæ•¸</th><th>åœ‹èªäººæ•¸</th><th>æ•¸å­¸äººæ•¸</th><th>è‹±èªäººæ•¸</th></tr></thead><tbody>`;
        const sortedGrades = Object.keys(gradeStats).sort((a,b) => parseInt(a)-parseInt(b));
        sortedGrades.forEach(g => {
            totalChi += gradeStats[g].c;
            totalMath += gradeStats[g].m;
            totalEng += gradeStats[g].e;
            totalStudents += gradeStats[g].studentCount;
            html += `<tr><td>${g} å¹´ç´š</td><td class="stat-student-count">${gradeStats[g].studentCount}</td><td class="stat-chi">${gradeStats[g].c}</td><td class="stat-math">${gradeStats[g].m}</td><td class="stat-eng">${gradeStats[g].e}</td></tr>`;
        });
        html += `<tr class="stat-total-row"><td>å…¨æ ¡ç¸½è¨ˆ</td><td class="stat-student-count">${totalStudents}</td><td class="stat-chi">${totalChi}</td><td class="stat-math">${totalMath}</td><td class="stat-eng">${totalEng}</td></tr>`;
        html += `</tbody></table><br><hr><br>`;
        
        html += `<h3>(2) å„ç­ç´šæ‡‰è€ƒäººæ•¸çµ±è¨ˆè¡¨ (ä¾å¹´ç´šåˆ†é¡)</h3>`;
        
        sortedGrades.forEach(g => {
            let subChi = 0, subMath = 0, subEng = 0;
            html += `<h4>ã€${g} å¹´ç´šã€‘</h4>`;
            html += `<table class="list-table">
                        <thead><tr><th>ç­ç´š</th><th>åœ‹èªäººæ•¸</th><th>æ•¸å­¸äººæ•¸</th><th>è‹±èªäººæ•¸</th></tr></thead><tbody>`;
            const classesInGrade = detailStats[g];
            const sortedClasses = Object.keys(classesInGrade).sort((a,b) => parseInt(a) - parseInt(b));
            sortedClasses.forEach(cls => {
                const st = classesInGrade[cls];
                // åªåˆ—å‡ºæœ‰äººè¦è€ƒè©¦çš„ç­ç´š
                if (st.c > 0 || st.m > 0 || st.e > 0) {
                    subChi += st.c;
                    subMath += st.m;
                    subEng += st.e;
                    html += `<tr><td>${cls} ç­</td><td class="stat-chi">${st.c}</td><td class="stat-math">${st.m}</td><td class="stat-eng">${st.e}</td></tr>`;
                }
            });
            html += `<tr class="stat-total-row"><td>${g}å¹´ç´šç¸½è¨ˆ</td><td class="stat-chi">${subChi}</td><td class="stat-math">${subMath}</td><td class="stat-eng">${subEng}</td></tr>`;
            html += `</tbody></table>`;
        });
        container.innerHTML = html;
    }

    // --- åŠŸèƒ½ 4ï¼šå°å¸«ç•™å­˜åå–® (åªåˆ—æœ‰Xçš„) ---
    function initTeacherClassSelector() {
        const container = document.getElementById('class-selector-container');
        container.innerHTML = '';
        if (globalStudents.length === 0) return;
        const gradeMap = {};
        globalStudents.forEach(s => {
            if (!gradeMap[s.grade]) gradeMap[s.grade] = new Set();
            gradeMap[s.grade].add(s.cls);
        });
        const sortedGrades = Object.keys(gradeMap).sort((a,b) => parseInt(a)-parseInt(b));
        sortedGrades.forEach(g => {
            const card = document.createElement('div');
            card.className = 'grade-group-card';
            const header = document.createElement('div');
            header.className = 'grade-group-header';
            header.innerHTML = `<span>${g} å¹´ç´š</span><button class="btn btn-blue" style="font-size:12px; padding:3px 8px;" onclick="toggleGradeClasses('${g}', true)">å…¨é¸</button>`;
            card.appendChild(header);
            const cbContainer = document.createElement('div');
            cbContainer.className = 'class-checkbox-grid';
            const classes = Array.from(gradeMap[g]).sort((a,b) => parseInt(a)-parseInt(b));
            classes.forEach(cls => {
                const wrapper = document.createElement('div');
                wrapper.className = 'class-checkbox-item';
                wrapper.innerHTML = `<label style="width:auto; margin:0; cursor:pointer;"><input type="checkbox" class="cls-cb grade-${g}" value="${cls}" data-grade="${g}"> ${cls}ç­</label>`;
                cbContainer.appendChild(wrapper);
            });
            card.appendChild(cbContainer);
            container.appendChild(card);
        });
    }

    function toggleGradeClasses(grade, checked) {
        document.querySelectorAll(`.cls-cb.grade-${grade}`).forEach(cb => cb.checked = checked);
    }
    function toggleAllGrades(checked) {
        document.querySelectorAll('.cls-cb').forEach(cb => cb.checked = checked);
    }

    function generateTeacherLists() {
        const container = document.getElementById('print-section-teachers');
        container.innerHTML = '';
        const checkedBoxes = document.querySelectorAll('.cls-cb:checked');
        if(checkedBoxes.length === 0) { container.innerHTML = '<p style="text-align:center; color:red;">è«‹å…ˆå‹¾é¸è‡³å°‘ä¸€å€‹ç­ç´š</p>'; return; }
        
        const selectedTargets = []; 
        checkedBoxes.forEach(cb => {
            selectedTargets.push({ grade: cb.dataset.grade, cls: cb.value });
        });

        selectedTargets.sort((a,b) => {
            if(a.grade !== b.grade) return parseInt(a.grade) - parseInt(b.grade);
            return parseInt(a.cls) - parseInt(b.cls);
        });

        let html = '';
        selectedTargets.forEach(target => {
            const cls = target.cls;
            const grade = target.grade;
            // å°å¸«åå–®ï¼šåªåˆ—å‡ºæœ‰ä»»ä¸€ç§‘è¦è€ƒè©¦(X)çš„å­¸ç”Ÿ
            const classStudents = globalStudents.filter(s => s.cls === cls && s.grade === grade && (s.chi || s.math || s.eng));

            if(classStudents.length > 0) {
                let cCount = 0, mCount = 0, eCount = 0;
                classStudents.forEach(s => {
                    if(s.chi) cCount++;
                    if(s.math) mCount++;
                    if(s.eng) eCount++;
                });

                const dateC = document.getElementById(`date-c-${grade}`).value;
                const locC = document.getElementById(`loc-c-${grade}`).value;
                const dateM = document.getElementById(`date-m-${grade}`).value;
                const locM = document.getElementById(`loc-m-${grade}`).value;
                const dateE = document.getElementById(`date-e-${grade}`).value;
                const locE = document.getElementById(`loc-e-${grade}`).value;

                html += `<div class="teacher-block">`;
                html += `<div class="teacher-header">
                            <span>${grade}å¹´ ${cls} ç­ - å­¸ç¿’æ‰¶åŠ©æ¸¬é©—åå–® (å°å¸«ç•™å­˜)</span>
                            <span style="font-size:12pt;">åœ‹:${cCount}  æ•¸:${mCount}  è‹±:${eCount}</span>
                         </div>`;
                html += `<table class="teacher-table">
                            <thead><tr>
                                <th style="width:4%;">å¹´</th>
                                <th style="width:4%;">ç­</th>
                                <th style="width:4%;">è™Ÿ</th>
                                <th style="width:8%;">å§“å</th>
                                <th style="width:4%;">åœ‹</th>
                                <th style="width:4%;">æ•¸</th>
                                <th style="width:4%;">è‹±</th>
                                <th style="width:14%;">åœ‹è€ƒæ™‚é–“</th><th style="width:8%;">åœ‹è€ƒåœ°é»</th>
                                <th style="width:14%;">æ•¸è€ƒæ™‚é–“</th><th style="width:8%;">æ•¸è€ƒåœ°é»</th>
                                <th style="width:14%;">è‹±è€ƒæ™‚é–“</th><th style="width:8%;">è‹±è€ƒåœ°é»</th>
                            </tr></thead><tbody>`;
                
                classStudents.forEach(s => {
                    // åªæœ‰è©²ç”Ÿè€ƒè©²ç§‘(X)ï¼Œæ‰é¡¯ç¤ºæ™‚é–“åœ°é»
                    const chiTime = s.chi ? dateC : "";
                    const chiLoc = s.chi ? locC : "";
                    const mathTime = s.math ? dateM : "";
                    const mathLoc = s.math ? locM : "";
                    const engTime = s.eng ? dateE : "";
                    const engLoc = s.eng ? locE : "";

                    html += `<tr>
                                <td>${s.grade}</td>
                                <td>${s.cls}</td>
                                <td>${s.seat}</td>
                                <td>${s.name}</td>
                                <td>${s.chi ? 'â—' : ''}</td>
                                <td>${s.math ? 'â—' : ''}</td>
                                <td>${s.eng ? 'â—' : ''}</td>
                                <td class="info-cell">${chiTime}</td><td class="info-cell">${chiLoc}</td>
                                <td class="info-cell">${mathTime}</td><td class="info-cell">${mathLoc}</td>
                                <td class="info-cell">${engTime}</td><td class="info-cell">${engLoc}</td>
                             </tr>`;
                });
                html += `</tbody></table>`;
                html += `</div>`;
                html += `<div class="page-break"></div>`; 
            }
        });
        container.innerHTML = html;
    }

    function printArea(mode) {
        // v18.0 æ›´æ–°ï¼šæ ¹æ“šæ¨¡å¼åˆ‡æ› CSS class
        if (mode === 'teachers-compact') {
            document.body.className = 'print-teachers-compact';
        } else {
            document.body.className = 'print-' + mode;
        }
        window.print();
        setTimeout(() => { document.body.className = ''; }, 1000);
    }
</script>

</body>
</html>
