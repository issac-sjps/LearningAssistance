<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ‰¶åŠ©æ¸¬é©—ç³»çµ± v50.1 (æ™‚é–“è¡¨ç©ºç™½éš±è—é‚è¼¯)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; margin: 0; background-color: #f4f4f4; padding-bottom: 50px; }
        
        /* --- é¡è‰²å®šç¾© --- */
        .stat-chi { color: #cc0000; font-weight: bold; }
        .stat-math { color: #00008B; font-weight: bold; }
        .stat-eng { color: #006400; font-weight: bold; }
        .stat-total-row { background-color: #f0f0f0; font-weight: bold; border-top: 2px solid #666; }
        .stat-student-count { font-weight: bold; color: #333; background-color: #e8f0fe; }

        /* --- ä»‹é¢æ¨£å¼ --- */
        .navbar { 
            background-color: #2c3e50; 
            color: white; 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px;
        }
        
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .nav-right { display: flex; flex-wrap: wrap; gap: 15px; }

        .nav-group {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 6px;
            gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .group-label {
            font-size: 13px;
            color: #f1c40f; 
            font-weight: bold;
            margin-right: 5px;
            border-right: 1px solid #7f8c8d;
            padding-right: 8px;
            white-space: nowrap;
        }

        .navbar button { 
            padding: 6px 10px; 
            cursor: pointer; 
            border: none; 
            background: #555; 
            color: #ccc; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 14px;
        }
        .navbar button.active { background: #f39c12; color: #fff; }
        .navbar button:hover:not(.active) { background: #777; }
        
        .btn-import { background-color: #2980b9 !important; color: white !important; }
        .btn-import:hover { background-color: #3498db !important; }
        .btn-import.active { background-color: #f39c12 !important; }

        .container { max-width: 1100px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .settings-box { border: 2px solid #e0e0e0; padding: 20px; margin-bottom: 20px; background-color: #fff; border-radius: 8px; }
        .config-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; flex-wrap: wrap; }
        .config-row label { font-weight: bold; width: 60px; flex-shrink: 0; }
        input[type="text"], textarea, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; }
        textarea { resize: vertical; line-height: 1.5; font-family: inherit; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; font-size: 14px; margin-right: 5px; }
        .btn-blue { background-color: #3498db; } .btn-blue:hover { background-color: #2980b9; }
        .btn-green { background-color: #27ae60; } .btn-green:hover { background-color: #219150; }
        .btn-gray { background-color: #95a5a6; }
        .btn-red { background-color: #e74c3c; } .btn-red:hover { background-color: #c0392b; }
        
        .btn.active { background-color: #f39c12; border: 2px solid #e67e22; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* é è¦½å€ */
        #preview-container {
            background-color: #525659; padding: 40px; min-height: 500px;
            display: none; text-align: center;
        }
        .preview-page-wrapper {
            display: inline-block; box-shadow: 0 0 10px rgba(0,0,0,0.5); margin-bottom: 20px;
            background: white; text-align: left;
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ --- */
        @media print {
            @page { margin: 5mm; size: A4 portrait; }
            
            .navbar, .container, #preview-header-controls { display: none !important; }
            
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background-color: white !important;
                height: 100%;
                width: 100%;
                overflow: visible !important;
            }
            
            #preview-container {
                display: block !important;
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                width: 100%;
                font-size: 0; 
            }
            
            .preview-page-wrapper {
                display: block !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                page-break-after: always !important;
                width: 100%;
                font-size: 14pt;
            }
            
            .preview-page-wrapper:last-child {
                page-break-after: auto !important;
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
            
            body.print-teachers-compact .preview-page-wrapper { page-break-after: auto; margin-bottom: 0; }
            body.print-teachers-compact .page-break { page-break-after: auto; border-bottom: 2px dashed #999; margin: 25px 0; height: 1px; position: relative; display: block; }
            body.print-teachers-compact .page-break::after { content: "âœ‚ï¸ è£åˆ‡ç·š"; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; font-size: 10pt; color: #666; }

            .survey-page { font-size: 14pt !important; line-height: 1.3 !important; }
            .survey-title { font-size: 18pt !important; margin-bottom: 5px !important; }
            .reply-slip-title { font-size: 16pt !important; }
            .survey-body p { margin: 3px 0 !important; }
            
            table.survey-table { font-size: 13pt !important; }
            table.survey-table td, table.survey-table th { padding: 3px !important; }
            
            .split-cell { padding: 0 !important; }
        }

        /* å ±è¡¨é€šç”¨ */
        .sheet-page { width: 195mm; min-height: 270mm; background: white; padding: 5mm; margin: 0 auto; box-sizing: border-box; }
        table.std-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12pt; text-align: center; font-family: "æ¨™æ¥·é«”"; }
        table.std-table th, table.std-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
        table.std-table th { background-color: #f0f0f0; font-weight: bold; }

        /* é€šçŸ¥å–® (è¯çµ¡ç°¿å°æ¢) */
        .slip-container { width: 100%; border-bottom: 1px dashed #bbb; padding-bottom: 10px; margin-bottom: 10px; }
        .slip-header { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .text-red { color: red !important; font-weight: bold; }
        .square { display: inline-block; width: 14px; height: 14px; margin-right: 3px; vertical-align: middle; border: 1px solid #000; line-height: 12px; text-align: center; font-size: 12px; }

        /* å°å¸«åå–® */
        .teacher-header { background:#333; color:white; padding:5px 10px; font-weight:bold; display:flex; justify-content:space-between; font-size:14pt; -webkit-print-color-adjust: exact; }
        .teacher-table { font-size: 10pt; }
        .info-cell { font-size: 9pt; color: #444; }
        .teacher-break-line { border-bottom: 2px dashed #999; margin: 20px 0; position: relative; height: 1px; }
        .teacher-break-line::after { content: "âœ‚ï¸ è£åˆ‡ç·š"; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 5px; font-size: 12px; color: #666; }

        /* èª¿æŸ¥è¡¨ & æ­£å¼é€šçŸ¥æ›¸å…±ç”¨æ¨£å¼ */
        .survey-sheet { 
            width: 195mm; 
            height: 275mm; 
            background: white; 
            padding: 5mm 8mm; 
            margin: 0 auto; 
            box-sizing: border-box; 
            font-family: "æ¨™æ¥·é«”", "KaiTi", serif; 
            font-size: 14pt; 
            line-height: 1.4;
            color: #000; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
        }
        
        .survey-title { text-align: center; font-size: 18pt; font-weight: bold; margin-bottom: 10px; color: #000; }
        .survey-body p { margin: 4px 0; text-align: justify; }
        .survey-indent { margin-left: 0; text-indent: 0; }
        
        .notice-content-compact { font-size: 11.5pt; line-height: 1.25; }
        .notice-content-compact p, .notice-content-compact div { margin-bottom: 2px; }
        
        .cut-line { border-top: 2px dashed #000; margin: 5px 0; text-align: center; position: relative; height: 15px; }
        .cut-line span { background: white; padding: 0 10px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 12px; white-space: nowrap; }
        .reply-title { text-align: center; font-weight: bold; font-size: 16pt; margin-bottom: 5px; } 
        .checkbox-cell { text-align: left; padding-left: 10px !important; }
        .checkbox-row { margin-bottom: 3px; }

        /* èª¿æŸ¥è¡¨å°ˆç”¨è¡¨æ ¼ */
        table.survey-table { font-size: 13pt; width: 100%; border-collapse: collapse; border: 2px solid #000; text-align: center; }
        table.survey-table th, table.survey-table td { border: 1px solid #000; padding: 4px; vertical-align: middle; }
        table.survey-table th { background-color: #f0f0f0; }
        
        .split-cell { padding: 0 !important; vertical-align: top !important; }
        .split-top { border-bottom: 1px solid #000; padding: 3px 0; background-color: #fcfcfc; font-weight: bold; }
        .split-bottom { padding: 8px 0; font-weight: bold; font-size: 16pt; min-height: 40px; display: flex; align-items: center; justify-content: center; }

        /* èª¿æŸ¥è¡¨è¨­å®š */
        .survey-config-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .survey-config-item { display: flex; flex-direction: column; }
        
        .mode-selector-box {
            background-color: #dcedc8;
            border: 2px solid #8bc34a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .mode-selector-box select { font-size: 16px; font-weight: bold; padding: 8px; width: 250px; border: 2px solid #558b2f; color: #33691e; }
        
        /* å°å¸«é¸å–® */
        .class-selector-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .grade-group-card { border: 1px solid #ccc; border-radius: 5px; padding: 10px; background-color: #f9f9f9; }
        .grade-group-header { font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .class-checkbox-grid { display: flex; flex-wrap: wrap; gap: 8px; }

        /* å®¶é•·é€šçŸ¥æ›¸æ™‚é–“è¡¨æ¨£å¼ (ç™½åº•) */
        table.schedule-table { width: 100%; border-collapse: collapse; border: 2px solid #000; margin: 3px 0; font-size: 10.5pt; background: white; }
        table.schedule-table th, table.schedule-table td { border: 1px solid #000; padding: 3px; text-align: center; color: #000; }
        table.schedule-table th { background-color: #f0f0f0; font-weight: bold; }
        table.schedule-table td { vertical-align: top; }
        .sch-time { font-weight: bold; display: block; margin-bottom: 1px; }
        .sch-loc { font-size: 0.9em; color: #444; }

        /* å€‹åˆ¥å­¸ç”Ÿè€ƒè©¦ç§‘ç›®è¡¨æ¨£å¼ */
        table.student-status-table { width: 100%; border-collapse: collapse; border: 2px solid #000; margin: 5px 0; text-align: center; font-size: 11pt; }
        table.student-status-table td { border: 1px solid #000; padding: 4px; }
        .status-header { font-weight: bold; background-color: #f9f9f9; }
        
        #data-preview-area table th { position: sticky; top: 0; background-color: #eee; z-index: 1; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-left">
            <h2 style="margin:0;">æ¸¬é©—ç³»çµ± v50.1</h2>
            <button class="active btn-import" onclick="switchTab('data')">1. è³‡æ–™åŒ¯å…¥</button>
        </div>
        
        <div class="nav-right">
            <div class="nav-group">
                <span class="group-label">è€ƒè©¦ç”¨</span>
                <button onclick="switchTab('slips')">è€ƒè©¦é€šçŸ¥å–®</button>
                <button onclick="switchTab('idlist')">è€ƒè©¦ç°½åˆ°è¡¨</button>
                <button onclick="switchTab('stats')">è€ƒè©¦çµ±è¨ˆå ±è¡¨</button>
                <button onclick="switchTab('teachers')">è€ƒè©¦çµ¦å°å¸«åå–®</button>
                <button onclick="switchTab('parent-notice-set')" style="background:#8e44ad; color:white;">çµ¦å®¶é•·é€šçŸ¥æ›¸è¨­å®š</button>
                <button onclick="switchTab('parent-notice-print')" style="background:#8e44ad; color:white;">çµ¦å®¶é•·é€šçŸ¥æ›¸åˆ—å°</button>
            </div>
            
            <div class="nav-group">
                <span class="group-label">æ„é¡˜èª¿æŸ¥è¡¨</span>
                <button onclick="switchTab('surveys-set')">ä¸Šèª²æ„é¡˜èª¿æŸ¥è¡¨è¨­å®š</button>
                <button onclick="switchTab('surveys-print')">ä¸Šèª²æ„é¡˜èª¿æŸ¥è¡¨åˆ—å°</button>
            </div>
        </div>
    </div>

    <div class="container" id="config-panel">
        
        <div id="tab-data" class="tab-content active">
            <div class="settings-box">
                <h3>æ­¥é©Ÿä¸€ï¼šåŒ¯å…¥ Excel</h3>
                <input type="file" id="uploadFile" accept=".csv, .xlsx, .xls" />
                <p class="hint-text" style="color:#666; margin-top:10px;">éœ€åŒ…å«ï¼šç›®å‰å¹´ç´šã€ç­ç´šã€åº§è™Ÿã€å§“åã€åœ‹èªæ–‡æ¸¬é©—ã€æ•¸å­¸æ¸¬é©—ã€è‹±èªæ¸¬é©— (æ‰“Xç‚ºåƒåŠ )</p>
                <div id="data-status" style="margin-top:10px; font-weight:bold; color:red;">å°šæœªåŒ¯å…¥è³‡æ–™</div>
                
                <div id="data-preview-area" style="margin-top:20px; border-top:2px dashed #ddd; padding-top:10px;"></div>
            </div>
        </div>

        <div id="tab-slips" class="tab-content">
            <div class="settings-box">
                <h3>è€ƒè©¦é€šçŸ¥å–®åƒæ•¸ (è¯çµ¡ç°¿å°æ¢)</h3>
                <div class="config-row" style="background:#e8f4fd; padding:10px;">
                    <label style="width:80px;">æ¨™é¡Œ</label>
                    <input type="text" id="slip-title" onchange="saveConfig()" value="æ•™è‚²éƒ¨-æ–°èŠåœ‹å°-å­¸ç¿’æ‰¶åŠ©-æˆé•·æ¸¬é©— (è«‹å”åŠ©è²¼æ–½æ¸¬ç•¶é€±è¯çµ¡ç°¿)">
                </div>
                <div id="grade-settings-area"></div>
                <div style="margin-top:20px; text-align:center;">
                    <b>åˆ—å°ç§‘ç›®ï¼š</b>
                    <label><input type="checkbox" id="p-chi" checked> åœ‹èª</label>
                    <label><input type="checkbox" id="p-math"> æ•¸å­¸</label>
                    <label><input type="checkbox" id="p-eng"> è‹±èª</label>
                    <br><br>
                    <button class="btn btn-green" onclick="renderSlips()">ç”¢ç”Ÿä¸¦é è¦½é€šçŸ¥å–®</button>
                </div>
            </div>
        </div>

        <div id="tab-parent-notice-set" class="tab-content">
            <div class="settings-box">
                <h3>çµ¦å®¶é•·é€šçŸ¥æ›¸è¨­å®š (æ­£å¼å…¬æ–‡)</h3>
                
                <div class="mode-selector-box" style="background:#e1bee7; border-color:#8e44ad;">
                    <div style="margin-bottom:5px; color:#4a148c; font-weight:bold;">â–¼ è«‹é¸æ“‡æ¸¬é©—é¡å‹ (åˆ‡æ›å¾Œæœƒè¼‰å…¥é è¨­æ–‡å­—) â–¼</div>
                    <select id="pn-type" onchange="applyNoticeTemplate()" style="border-color:#4a148c; color:#4a148c;">
                        <option value="growth">ğŸ“ˆ æˆé•·æ¸¬é©— (é è¨­)</option>
                        <option value="screening">ğŸ” ç¯©é¸æ¸¬é©—</option>
                    </select>
                </div>

                <div class="survey-config-grid">
                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>é€šçŸ¥æ›¸æ¨™é¡Œ</label>
                        <input type="text" id="pn-title" onchange="saveParentNoticeConfig()">
                    </div>
                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>é–‹é ­å•å€™èª</label>
                        <textarea id="pn-intro" rows="6" onchange="saveParentNoticeConfig()"></textarea>
                    </div>
                    
                    <div class="survey-config-item" style="grid-column: span 2;">
                         <label>ç›®çš„èˆ‡åŸå›  (èªªæ˜æ–‡å­—)</label>
                         <textarea id="pn-reason" rows="5" onchange="saveParentNoticeConfig()"></textarea>
                    </div>

                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>é å°¾ç½²å</label>
                        <input type="text" id="pn-footer" onchange="saveParentNoticeConfig()">
                    </div>

                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>å›æ¢æ¨™é¡Œ</label>
                        <input type="text" id="pn-reply-title" onchange="saveParentNoticeConfig()">
                    </div>
                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>å›æ¢ç¹³äº¤æœŸé™</label>
                        <input type="text" id="pn-reply-deadline" onchange="saveParentNoticeConfig()">
                    </div>
                </div>
                <div style="margin-top:15px; text-align:center;">
                    <button class="btn btn-blue" onclick="switchTab('parent-notice-print')">è¨­å®šå®Œæˆï¼Œå‰å¾€åˆ—å° ğŸ‘‰</button>
                </div>
            </div>
        </div>

        <div id="tab-parent-notice-print" class="tab-content">
             <div class="settings-box">
                <h3>çµ¦å®¶é•·é€šçŸ¥æ›¸åˆ—å°</h3>
                <div style="text-align: center; padding: 20px;">
                    <button class="btn btn-green" onclick="renderParentNotices()">ğŸ”„ ç”¢ç”Ÿå®¶é•·é€šçŸ¥æ›¸</button>
                    <button class="btn btn-green" onclick="safePrint()">ğŸ–¨ï¸ ç¢ºèªåˆ—å°</button>
                </div>
            </div>
        </div>

        <div id="tab-idlist" class="tab-content">
            <div class="settings-box">
                <h3>è€ƒè©¦ç°½åˆ°è¡¨ (åˆ†ç§‘åˆ—å°)</h3>
                <div style="text-align:center; margin-bottom:15px;">
                    <p style="color:#666;">(å‹¾é¸å¤šé …æ™‚ï¼Œæœƒè‡ªå‹•ä¾åºç”¢ç”Ÿåˆ†é–‹çš„ç°½åˆ°è¡¨)</p>
                    <label style="margin-right:15px;"><input type="checkbox" id="sign-chi" checked> åœ‹èªå°ˆç”¨è¡¨</label>
                    <label style="margin-right:15px;"><input type="checkbox" id="sign-math"> æ•¸å­¸å°ˆç”¨è¡¨</label>
                    <label><input type="checkbox" id="sign-eng"> è‹±èªå°ˆç”¨è¡¨</label>
                </div>
                <div style="text-align:center;"><button class="btn btn-green" onclick="renderCheckList()">ç”¢ç”Ÿä¸¦é è¦½</button></div>
            </div>
        </div>

        <div id="tab-stats" class="tab-content">
            <div class="settings-box">
                <h3>è€ƒè©¦çµ±è¨ˆå ±è¡¨</h3>
                <div style="text-align:center;"><button class="btn btn-green" onclick="renderStats()">ç”¢ç”Ÿä¸¦é è¦½</button></div>
            </div>
        </div>

        <div id="tab-teachers" class="tab-content">
            <div class="settings-box">
                <h3>è€ƒè©¦çµ¦å°å¸«åå–®</h3>
                <p>è«‹å‹¾é¸ç­ç´šï¼š<button class="btn btn-gray" style="font-size:12px;" onclick="toggleAllGrades(true)">å…¨é¸</button> <button class="btn btn-gray" style="font-size:12px;" onclick="toggleAllGrades(false)">å…¨æ¶ˆ</button></p>
                <div id="class-checkboxes" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;"></div>
                <div style="text-align:center;">
                    <button class="btn btn-green" onclick="renderTeachers(true)">ğŸ–¨ï¸ åˆ—å° (åˆ†é )</button>
                    <button class="btn btn-blue" onclick="renderTeachers(false)">âœ‚ï¸ åˆ—å° (ä¸åˆ†é )</button>
                </div>
            </div>
        </div>

        <div id="tab-surveys-set" class="tab-content">
            <div class="settings-box">
                <h3>ä¸Šèª²æ„é¡˜èª¿æŸ¥è¡¨è¨­å®š</h3>
                
                <div class="mode-selector-box">
                    <div style="margin-bottom:5px; color:#33691e; font-weight:bold;">â–¼ è«‹å…ˆé¸æ“‡è¦ç·¨è¼¯æˆ–åˆ—å°çš„èª¿æŸ¥è¡¨ç‰ˆæœ¬ â–¼</div>
                    <select id="survey-period-select" onchange="switchSurveyPeriod()">
                        <option value="summer">â˜€ï¸ æš‘å‡ å­¸ç¿’æ‰¶åŠ©</option>
                        <option value="semester1" selected>ğŸ‚ ä¸Šå­¸æœŸ å­¸ç¿’æ‰¶åŠ©</option>
                        <option value="winter">â˜ƒï¸ å¯’å‡ å­¸ç¿’æ‰¶åŠ©</option>
                        <option value="semester2">ğŸŒ± ä¸‹å­¸æœŸ å­¸ç¿’æ‰¶åŠ©</option>
                    </select>
                </div>

                <div class="survey-config-grid">
                    <div class="survey-config-item"><label>å­¸å¹´åº¦</label><input type="text" id="s-year" onchange="saveCurrentPeriod()"></div>
                    <div class="survey-config-item"><label>å­¸æœŸ/å‡æœŸ</label><input type="text" id="s-semester" onchange="saveCurrentPeriod()"></div>
                    <div class="survey-config-item"><label>ä¸Šèª²æ—¥æœŸ</label><input type="text" id="s-date" onchange="saveCurrentPeriod()"></div>
                    <div class="survey-config-item"><label>ä¸Šèª²æ™‚é–“</label><input type="text" id="s-time" onchange="saveCurrentPeriod()"></div>
                    
                    <div class="survey-config-item">
                        <label>ä¸Šèª²åœ°é»</label>
                        <input type="text" id="s-loc" onchange="saveCurrentPeriod()" placeholder="ä¾‹ï¼šæš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤">
                    </div>
                    <div class="survey-config-item">
                        <label>åœ°é»å‚™è¨» (å¦‚ï¼šå¦ç™¼é€šçŸ¥)</label>
                        <input type="text" id="s-note" onchange="saveCurrentPeriod()" placeholder="ä¾‹ï¼šï¼Œè‹¥ç¢ºå®šé–‹ç­ï¼Œå¦ç™¼é€šçŸ¥å–®ã€‚">
                    </div>
                    
                    <div class="survey-config-item"><label>ç¹³äº¤æœŸé™</label><input type="text" id="s-deadline" onchange="saveCurrentPeriod()"></div>
                    
                    <div class="survey-config-item" style="grid-column: span 2;">
                        <label>é å°¾ç½²å</label>
                        <input type="text" id="s-footer" onchange="saveCurrentPeriod()">
                    </div>
                </div>
                
                <div style="background:#fff9e6; padding:15px; border-radius:5px; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label style="color:#d35400;">ç›®çš„èˆ‡åŸå›  (èªªæ˜æ–‡å­—)ï¼š</label>
                        <button class="btn btn-gray" style="font-size:12px; padding:3px 8px;" onclick="loadDefaultTemplate()">ğŸ”„ è¼‰å…¥é è¨­ç¯„æœ¬</button>
                    </div>
                    <textarea id="s-reasons" rows="6" onchange="saveCurrentPeriod()"></textarea>
                </div>
                <div style="margin-top:15px; text-align:center;">
                    <button class="btn btn-blue" onclick="switchTab('surveys-print')">è¨­å®šå®Œæˆï¼Œå‰å¾€åˆ—å° ğŸ‘‰</button>
                </div>
            </div>
        </div>

        <div id="tab-surveys-print" class="tab-content">
            <div class="settings-box">
                <h3>ä¸Šèª²æ„é¡˜èª¿æŸ¥è¡¨åˆ—å° (é è¦½èˆ‡åˆ—å°)</h3>
                <div style="text-align: center; padding: 20px;">
                    <p style="color:#666; margin-bottom:15px;">ç›®å‰é¸æ“‡ç‰ˆæœ¬ï¼š<b id="print-current-version" style="color:#33691e;">ä¸Šå­¸æœŸ</b></p>
                    <button class="btn btn-green" onclick="renderSurveys()">ğŸ”„ ç”¢ç”Ÿèª¿æŸ¥è¡¨</button>
                    <button class="btn btn-green" onclick="safePrint()">ğŸ–¨ï¸ ç¢ºèªåˆ—å°</button>
                </div>
            </div>
        </div>

    </div>

    <div id="preview-container">
        <div style="background:#333; color:white; padding:10px; position:sticky; top:0; z-index:999; display:flex; justify-content:space-between; align-items:center;" id="preview-header-controls">
            <span style="font-size:18px;">ğŸ“„ åˆ—å°é è¦½</span>
            <div>
                <button class="btn btn-green" onclick="safePrint()">ğŸ–¨ï¸ åˆ—å°</button>
                <button class="btn btn-red" onclick="closePreview()">âŒ è¿”å›ä¿®æ”¹</button>
            </div>
        </div>
        <div id="preview-content"></div>
    </div>

<script>
    let globalStudents = [];
    
    // v49.0 æ›´æ–°ï¼šæ‰€æœ‰åœ°é»çµ±ä¸€æ”¹ç‚º "æš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤"
    const periodDefaults = {
        summer: {
            year: "113", semester: "æš‘å‡", date: "114å¹´7æœˆ1æ—¥~7æœˆ20æ—¥", time: "é€±ä¸€è‡³é€±äº” 8:40~11:50",
            loc: "æš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤", note: "ï¼Œè‹¥ç¢ºå®šé–‹ç­ï¼Œå¦ç™¼é€šçŸ¥å–®ã€‚", deadline: "114.6.20ï¼ˆäº”ï¼‰",
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            reasons: `(1)ç™¼æ”¾å°è±¡ç‚ºç¯©é¸æ¸¬é©—æœªé€šéæˆ–å¯ä»¥åƒåŠ æ‰¶åŠ©ä¹‹åå–®ã€‚
(2)æœ‰æ„é¡˜åƒèˆ‡æš‘å‡èª²ç¨‹çš„åŒå­¸ï¼Œæ­¡è¿åƒåŠ ã€‚
(3)ç”±æ•™è‚²éƒ¨æä¾›å­¸æ ¡ç›¸é—œç¶“è²»ï¼Œçµ¦èˆ‡æœªé€šéæ•™è‚²éƒ¨æª¢æ ¸çš„åŒå­¸ä¸Šè©²èª²ç¨‹ã€‚`
        },
        semester1: {
            year: "114", semester: "ä¸Šå­¸æœŸ", date: "114å¹´9æœˆ22æ—¥~114å¹´12æœˆ29æ—¥", time: "é€±ä¸€ã€å››ï¼Œä¸‹åˆ16:00~17:30",
            loc: "æš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤", note: "ï¼Œè‹¥ç¢ºå®šé–‹ç­ï¼Œå¦ç™¼é€šçŸ¥å–®ã€‚", deadline: "114.9.9ï¼ˆæ˜ŸæœŸäºŒï¼‰9:00",
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            reasons: `(1)ç™¼æ”¾å°è±¡ç‚ºç¯©é¸æ¸¬é©—æœªé€šéæˆ–éœ€è¦æ‰¶åŠ©ä¹‹åå–®ã€‚
(2)æœŸä¸­å¾Œæœƒè«‹é€™äº›å­¸ç”Ÿé€²è¡Œæˆé•·æ¸¬é©—ï¼Œæª¢æ ¸æ‰¶åŠ©å­¸ç¿’ä¸Šèª²æˆæ•ˆã€‚
(3)æ¸¬é©—çš„ç›®çš„ç‚ºäº†æé†’å­¸æ‰¶ä»»èª²è€å¸«æª¢æ ¸è‡ªå·±çš„æ•™å­¸æˆæ•ˆèˆ‡å­¸ç”Ÿçš„å­¸ç¿’ç‹€æ³ã€‚
(4)ç”±æ•™è‚²éƒ¨æä¾›å­¸æ ¡ç›¸é—œç¶“è²»ï¼Œçµ¦èˆ‡æœªé€šéæ•™è‚²éƒ¨æª¢æ ¸çš„åŒå­¸ä¸Šè©²èª²ç¨‹ã€‚`
        },
        winter: {
            year: "114", semester: "å¯’å‡", 
            date: "115å¹´1æœˆ26æ—¥(ä¸€)~1æœˆ30æ—¥(äº”)", 
            time: "é€±ä¸€è‡³é€±äº” 8:00~12:00",       
            loc: "æš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤", note: "ï¼Œè‹¥ç¢ºå®šé–‹ç­ï¼Œå¦ç™¼é€šçŸ¥å–®ã€‚", 
            deadline: "114.12.19(äº”)",            
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            reasons: `(1)ç™¼æ”¾å°è±¡ç‚ºç¯©é¸æ¸¬é©—æœªé€šéæˆ–å¯ä»¥åƒåŠ æ‰¶åŠ©ä¹‹åå–®ã€‚
(2)æœ‰æ„é¡˜åƒèˆ‡å¯’å‡èª²ç¨‹çš„åŒå­¸ï¼Œæ­¡è¿åƒåŠ ã€‚
(3)ç”±æ•™è‚²éƒ¨æä¾›å­¸æ ¡ç›¸é—œç¶“è²»ï¼Œçµ¦èˆ‡æœªé€šéæ•™è‚²éƒ¨æª¢æ ¸çš„åŒå­¸ä¸Šè©²èª²ç¨‹ã€‚`
        },
        semester2: {
            year: "114", semester: "ä¸‹å­¸æœŸ", date: "115å¹´3æœˆ1æ—¥~6æœˆ30æ—¥", time: "é€±ä¸€ã€å››ï¼Œä¸‹åˆ16:00~17:30",
            loc: "æš«å®šè‡³å–„æ¨“äºŒæ¨“æ•™å®¤", note: "ï¼Œè‹¥ç¢ºå®šé–‹ç­ï¼Œå¦ç™¼é€šçŸ¥å–®ã€‚", deadline: "115.2.20ï¼ˆäº”ï¼‰",
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            reasons: `(1)ç™¼æ”¾å°è±¡ç‚ºç¯©é¸æ¸¬é©—æœªé€šéæˆ–å¯ä»¥åƒåŠ æ‰¶åŠ©ä¹‹åå–®ã€‚
(2)æœŸä¸­å¾Œæœƒè«‹é€™äº›å­¸ç”Ÿé€²è¡Œç¯©é¸æ¸¬é©—ï¼Œæª¢æ ¸æœ¬å­¸å¹´åº¦ä¸Šèª²å­¸ç¿’ä¸Šèª²æˆæ•ˆã€‚
(3)æ¸¬é©—çš„ç›®çš„ç‚ºäº†æé†’ç¾ä»»ä»»èª²è€å¸«æª¢æ ¸è‡ªå·±çš„æ•™å­¸æˆæ•ˆèˆ‡å­¸ç”Ÿçš„å­¸ç¿’ç‹€æ³ã€‚
(4)ç”±æ•™è‚²éƒ¨æä¾›å­¸æ ¡ç›¸é—œç¶“è²»ï¼Œçµ¦èˆ‡æœªé€šéæ•™è‚²éƒ¨æª¢æ ¸çš„åŒå­¸ä¸Šè©²èª²ç¨‹ã€‚`
        }
    };

    let surveyData = JSON.parse(JSON.stringify(periodDefaults));
    
    const noticeTemplates = {
        growth: {
            title: "114å­¸å¹´åº¦ä¸Šå­¸æœŸæ•™è‚²éƒ¨å­¸ç¿’æ‰¶åŠ©å¯¦æ–½æ–¹æ¡ˆ-æˆé•·æ¸¬é©—é€šçŸ¥å–®",
            intro: `(ä¸€)æ—¥æœŸï¼šã€114å¹´11æœˆ24æ—¥~114å¹´12æœˆ12æ—¥ã€‘å…±ä¸‰é€±ã€‚\n(äºŒ)æ™‚é–“ï¼šã€æ—©è‡ªä¿® 07:50~08:30ã€‘æˆ–ã€åˆä¼‘ 12:40~13:20ã€‘ã€‚\n(ä¸‰)åœ°é»ï¼šè©³è¦‹ä¸‹æ–¹æ™‚é–“è¡¨ã€‚\n(å››)è€ƒè©¦ç§‘ç›®ï¼šåœ‹èªã€æ•¸å­¸ã€è‹±èªã€‚\n(äº”)æœ¬é€šçŸ¥å–®å›æ¢è«‹æ–¼ã€114å¹´11æœˆ21æ—¥(æ˜ŸæœŸäº”) 16:00ã€‘å‰äº¤äºˆå°å¸«è½‰äº¤è‡³æ•™å‹™è™•ã€‚`,
            reason: `(ä¸€)ç™¼æ”¾å°è±¡ç‚ºç¯©é¸æ¸¬é©—æœªé€šéæˆ–éœ€è¦æ‰¶åŠ©ä¹‹åå–®ã€‚\n(äºŒ)æ¸¬é©—çš„ç›®çš„ç‚ºäº†æé†’å­¸æ‰¶ä»»èª²è€å¸«æª¢æ ¸è‡ªå·±çš„æ•™å­¸æˆæ•ˆèˆ‡å­¸ç”Ÿçš„å­¸ç¿’ç‹€æ³ã€‚\n(ä¸‰)è€ƒè©¦å…§å®¹ç‚ºæœ¬å­¸å¹´åº¦çš„æ•™å­¸å…§å®¹ã€‚`,
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            replyTitle: "114å­¸å¹´åº¦ä¸Šå­¸æœŸã€Œå­¸ç¿’æ‰¶åŠ©-æˆé•·æ¸¬é©—ã€é€šçŸ¥æ›¸",
            replyDeadline: "è«‹æ–¼ 114.11.21 (æ˜ŸæœŸäº”) 16:00 å‰äº¤äºˆå°å¸«å”åŠ©ç¹³äº¤è‡³æ•™å‹™è™•ç•™å­˜"
        },
        screening: {
            title: "114å­¸å¹´åº¦ä¸Šå­¸æœŸæ•™è‚²éƒ¨å­¸ç¿’æ‰¶åŠ©å¯¦æ–½æ–¹æ¡ˆ-ç¯©é¸æ¸¬é©—é€šçŸ¥å–®",
            intro: `(ä¸€)æ—¥æœŸï¼šã€114å¹´5æœˆ20æ—¥~6æœˆ10æ—¥ã€‘å…±ä¸‰é€±ã€‚\n(äºŒ)æ™‚é–“ï¼šã€æ—©è‡ªä¿® 07:50~08:30ã€‘æˆ–ã€åˆä¼‘ 12:40~13:20ã€‘ã€‚\n(ä¸‰)åœ°é»ï¼šè©³è¦‹ä¸‹æ–¹æ™‚é–“è¡¨ã€‚\n(å››)è€ƒè©¦ç§‘ç›®ï¼šåœ‹èªã€æ•¸å­¸ã€è‹±èªã€‚\n(äº”)æœ¬é€šçŸ¥å–®å›æ¢è«‹æ–¼ã€114å¹´5æœˆ15æ—¥(æ˜ŸæœŸäº”) 16:00ã€‘å‰äº¤äºˆå°å¸«è½‰äº¤è‡³æ•™å‹™è™•ã€‚`,
            reason: `(ä¸€)ç™¼æ”¾å°è±¡ç‚º113ä¸‹å­¸æœŸæœŸä¸­å¾Œæœ‰åƒèˆ‡ç¯©é¸æ¸¬é©—çš„åå–®ä¸­ï¼Œå…¶ä¸­è©²æ¸¬é©—æœªé€šéçš„åŒå­¸ã€‚\n(äºŒ)æ¸¬é©—çš„ç›®çš„ç‚ºäº†æé†’å­¸æ‰¶ä»»èª²è€å¸«æª¢æ ¸è‡ªå·±çš„æ•™å­¸æˆæ•ˆä»¥åŠç¢ºèªå­¸ç”Ÿçš„å­¸ç¿’ç‹€æ³ã€‚\n(ä¸‰)è€ƒè©¦å…§å®¹ç‚º113å­¸å¹´åº¦çš„æ•™å­¸å…§å®¹ï¼Œå‡è¨­ç›®å‰ç‚ºäºŒå¹´ç´šï¼Œè€ƒè©¦å…§å®¹ä¸€å¹´ç´šå…§å®¹ï¼Œé è¨ˆè€ƒé¡Œæœƒè·Ÿ11405çš„ç¯©é¸æ¸¬é©—ç›¸é—œæˆ–é¡ä¼¼ã€‚`,
            footer: "æ–°èŠåœ‹å°æ•™å‹™è™• 3411373 ä¸»ä»»#111 è¨»å†Šçµ„#112 æ•¬å•Ÿ",
            replyTitle: "114å­¸å¹´åº¦ä¸Šå­¸æœŸã€Œå­¸ç¿’æ‰¶åŠ©-ç¯©é¸æ¸¬é©—ã€é€šçŸ¥æ›¸",
            replyDeadline: "è«‹æ–¼ 114.5.15 (æ˜ŸæœŸäº”) 16:00 å‰äº¤äºˆå°å¸«å”åŠ©ç¹³äº¤è‡³æ•™å‹™è™•ç•™å­˜"
        }
    };

    let parentNoticeConfig = JSON.parse(JSON.stringify(noticeTemplates.growth));

    function init() {
        renderGradeSettings();
        loadConfig();
    }

    function renderGradeSettings() {
        const container = document.getElementById('grade-settings-area');
        let html = '';
        for(let i=1; i<=6; i++) {
            let defaultLoc = `${i}F-E åŒ–æ•™å®¤`;
            let defaultTime = "12/1(ä¸€) æ—©è‡ªä¿® 7:50~8:30";
            if(i==2) defaultTime = "12/2(äºŒ) æ—©è‡ªä¿® 7:50~8:30";
            if(i==3) defaultTime = "12/3(ä¸‰) æ—©è‡ªä¿® 7:50~8:30";
            if(i==4) defaultTime = "12/4(å››) æ—©è‡ªä¿® 7:50~8:30";
            if(i==5) defaultTime = "12/5(äº”) æ—©è‡ªä¿® 7:50~8:30";
            if(i==6) defaultTime = "12/6(å…­) æ—©è‡ªä¿® 7:50~8:30";

            html += `
            <div class="config-row">
                <label>${i} å¹´ç´š</label>
                <div style="flex:1; display:flex; gap:10px; flex-wrap:wrap;">
                    <div style="border-left:3px solid #cc0000; padding-left:5px;">
                        <span style="color:#cc0000; font-size:12px;">åœ‹èª</span><br>
                        <input type="text" id="d-c-${i}" placeholder="æ™‚é–“" style="width:260px; margin-bottom:2px;" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="l-c-${i}" placeholder="åœ°é»" style="width:150px;" value="${defaultLoc}" onchange="saveConfig()">
                    </div>
                    <div style="border-left:3px solid #00008B; padding-left:5px;">
                        <span style="color:#00008B; font-size:12px;">æ•¸å­¸</span><br>
                        <input type="text" id="d-m-${i}" placeholder="æ™‚é–“" style="width:260px; margin-bottom:2px;" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="l-m-${i}" placeholder="åœ°é»" style="width:150px;" value="${defaultLoc}" onchange="saveConfig()">
                    </div>
                    <div style="border-left:3px solid #006400; padding-left:5px;">
                        <span style="color:#006400; font-size:12px;">è‹±èª</span><br>
                        <input type="text" id="d-e-${i}" placeholder="æ™‚é–“" style="width:260px; margin-bottom:2px;" value="${defaultTime}" onchange="saveConfig()">
                        <input type="text" id="l-e-${i}" placeholder="åœ°é»" style="width:150px;" value="${defaultLoc}" onchange="saveConfig()">
                    </div>
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    function switchSurveyPeriod() {
        const p = document.getElementById('survey-period-select').value;
        const data = surveyData[p];
        
        document.getElementById('s-year').value = data.year;
        document.getElementById('s-semester').value = data.semester;
        document.getElementById('s-date').value = data.date;
        document.getElementById('s-time').value = data.time;
        document.getElementById('s-loc').value = data.loc;
        document.getElementById('s-note').value = data.note || ''; 
        document.getElementById('s-deadline').value = data.deadline;
        document.getElementById('s-reasons').value = data.reasons;
        document.getElementById('s-footer').value = data.footer;

        const map = { 'summer':'â˜€ï¸ æš‘å‡', 'semester1':'ğŸ‚ ä¸Šå­¸æœŸ', 'winter':'â˜ƒï¸ å¯’å‡', 'semester2':'ğŸŒ± ä¸‹å­¸æœŸ' };
        document.getElementById('print-current-version').innerText = map[p];
    }

    function saveCurrentPeriod() {
        const p = document.getElementById('survey-period-select').value;
        surveyData[p] = {
            year: document.getElementById('s-year').value,
            semester: document.getElementById('s-semester').value,
            date: document.getElementById('s-date').value,
            time: document.getElementById('s-time').value,
            loc: document.getElementById('s-loc').value,
            note: document.getElementById('s-note').value,
            deadline: document.getElementById('s-deadline').value,
            reasons: document.getElementById('s-reasons').value,
            footer: document.getElementById('s-footer').value
        };
        saveConfig();
    }

    function applyNoticeTemplate() {
        const type = document.getElementById('pn-type').value;
        const tmpl = noticeTemplates[type];
        
        document.getElementById('pn-title').value = tmpl.title;
        document.getElementById('pn-intro').value = tmpl.intro;
        document.getElementById('pn-reason').value = tmpl.reason;
        document.getElementById('pn-footer').value = tmpl.footer;
        document.getElementById('pn-reply-title').value = tmpl.replyTitle;
        document.getElementById('pn-reply-deadline').value = tmpl.replyDeadline;
        
        saveParentNoticeConfig();
    }

    function saveParentNoticeConfig() {
        parentNoticeConfig = {
            title: document.getElementById('pn-title').value,
            intro: document.getElementById('pn-intro').value,
            reason: document.getElementById('pn-reason').value,
            footer: document.getElementById('pn-footer').value,
            replyTitle: document.getElementById('pn-reply-title').value,
            replyDeadline: document.getElementById('pn-reply-deadline').value
        };
        saveConfig();
    }

    function loadDefaultTemplate() {
        const p = document.getElementById('survey-period-select').value;
        if(confirm(`ç¢ºå®šè¦å°‡ã€${p}ã€‘çš„èªªæ˜æ–‡å­—é‚„åŸæˆé è¨­å€¼å—ï¼Ÿ`)) {
            document.getElementById('s-reasons').value = periodDefaults[p].reasons;
            saveCurrentPeriod();
        }
    }

    function saveConfig() {
        const config = {
            slipTitle: document.getElementById('slip-title').value,
            grades: {},
            surveyPeriods: surveyData,
            parentNotice: parentNoticeConfig
        };
        for(let i=1; i<=6; i++) {
            config.grades[i] = {
                dC: document.getElementById(`d-c-${i}`).value, lC: document.getElementById(`l-c-${i}`).value,
                dM: document.getElementById(`d-m-${i}`).value, lM: document.getElementById(`l-m-${i}`).value,
                dE: document.getElementById(`d-e-${i}`).value, lE: document.getElementById(`l-e-${i}`).value,
            };
        }
        localStorage.setItem('exam_v50_1_config', JSON.stringify(config));
    }

    function loadConfig() {
        const saved = localStorage.getItem('exam_v50_1_config');
        if(saved) {
            const c = JSON.parse(saved);
            if(c.slipTitle) document.getElementById('slip-title').value = c.slipTitle;
            if(c.surveyPeriods) {
                surveyData = c.surveyPeriods;
                ['summer','semester1','winter','semester2'].forEach(k => {
                    if(!surveyData[k]) surveyData[k] = periodDefaults[k];
                    if(!surveyData[k].footer) surveyData[k].footer = periodDefaults[k].footer; 
                });
            }
            if(c.parentNotice) {
                parentNoticeConfig = c.parentNotice;
                document.getElementById('pn-title').value = parentNoticeConfig.title;
                document.getElementById('pn-intro').value = parentNoticeConfig.intro;
                document.getElementById('pn-reason').value = parentNoticeConfig.reason;
                document.getElementById('pn-footer').value = parentNoticeConfig.footer;
                document.getElementById('pn-reply-title').value = parentNoticeConfig.replyTitle;
                document.getElementById('pn-reply-deadline').value = parentNoticeConfig.replyDeadline;
            }
            if(c.grades) {
                for(let i=1; i<=6; i++) {
                    if(c.grades[i]) {
                        if(c.grades[i].dC) document.getElementById(`d-c-${i}`).value = c.grades[i].dC;
                        if(c.grades[i].lC) document.getElementById(`l-c-${i}`).value = c.grades[i].lC;
                        if(c.grades[i].dM) document.getElementById(`d-m-${i}`).value = c.grades[i].dM;
                        if(c.grades[i].lM) document.getElementById(`l-m-${i}`).value = c.grades[i].lM;
                        if(c.grades[i].dE) document.getElementById(`d-e-${i}`).value = c.grades[i].dE;
                        if(c.grades[i].lE) document.getElementById(`l-e-${i}`).value = c.grades[i].lE;
                    }
                }
            }
        }
        document.getElementById('survey-period-select').value = 'semester1';
        switchSurveyPeriod();
        
        document.getElementById('pn-title').value = parentNoticeConfig.title;
        document.getElementById('pn-intro').value = parentNoticeConfig.intro;
        document.getElementById('pn-reason').value = parentNoticeConfig.reason;
        document.getElementById('pn-footer').value = parentNoticeConfig.footer;
        document.getElementById('pn-reply-title').value = parentNoticeConfig.replyTitle;
        document.getElementById('pn-reply-deadline').value = parentNoticeConfig.replyDeadline;
    }

    document.getElementById('uploadFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            
            globalStudents = rawData.map((row, index) => {
                const checkX = (v) => v && (v.toString().toUpperCase().includes('X') || v.toString().includes('ï¼¸'));
                const checkAny = (v) => v && v.toString().trim().length > 0;
                const getStatus = (v) => {
                    if(!v) return '';
                    const s = v.toString().toUpperCase();
                    if(s.includes('X') || s.includes('ï¼¸')) return 'X';
                    if(s.includes('O') || s.includes('0') || s.includes('ï¼¯')) return 'O';
                    return '';
                };
                const rC = row['åœ‹èªæ–‡æ¸¬é©—']||row['åœ‹èª'];
                const rM = row['æ•¸å­¸æ¸¬é©—']||row['æ•¸å­¸'];
                const rE = row['è‹±èªæ¸¬é©—']||row['è‹±èª'];
                return {
                    id: index,
                    grade: (row['ç›®å‰å¹´ç´š']||row['å¹´ç´š']||'').toString().trim(),
                    cls: (row['ç­ç´š']||'').toString().trim(),
                    seat: (row['åº§è™Ÿ']||'').toString().trim(),
                    name: (row['å§“å']||'').toString().trim(),
                    idNo: (row['èº«åˆ†è­‰çµ±ä¸€ç·¨è™Ÿ']||row['èº«åˆ†è­‰']||'').toString().trim(),
                    chi: checkX(rC), math: checkX(rM), eng: checkX(rE),
                    statusC: getStatus(rC), statusM: getStatus(rM), statusE: getStatus(rE),
                    isCase: checkAny(rC) || checkAny(rM) || checkAny(rE)
                };
            });
            globalStudents.sort((a,b) => {
                if(a.grade!=b.grade) return parseInt(a.grade)-parseInt(b.grade);
                if(a.cls!=b.cls) return parseInt(a.cls)-parseInt(b.cls);
                return parseInt(a.seat)-parseInt(b.seat);
            });
            document.getElementById('data-status').innerText = `âœ… å·²è®€å– ${globalStudents.length} ç­†è³‡æ–™`;
            document.getElementById('data-status').style.color = 'green';
            
            // v50.0 å‘¼å«é è¦½
            renderDataPreview();
            
            initTeacherSelector(); 
        };
        reader.readAsArrayBuffer(file);
    });
    
    // v50.0 è³‡æ–™æª¢è¦–å‡½æ•¸
    function renderDataPreview() {
        const container = document.getElementById('data-preview-area');
        if (globalStudents.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<h4 style="margin:5px 0;">ğŸ“‹ è³‡æ–™åŒ¯å…¥æª¢è¦–</h4>';
        html += '<div style="max-height:400px; overflow-y:auto; border:1px solid #ccc;">';
        html += '<table class="std-table" style="width:100%; font-size:14px;">';
        html += '<thead style="position:sticky; top:0; background:#eee; z-index:1;"><tr><th>å¹´ç´š</th><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>åœ‹èª</th><th>æ•¸å­¸</th><th>è‹±èª</th><th>å‚™è¨»</th></tr></thead><tbody>';

        globalStudents.forEach(s => {
            html += `<tr>
                <td>${s.grade}</td>
                <td>${s.cls}</td>
                <td>${s.seat}</td>
                <td>${s.name}</td>
                <td style="${s.chi?'color:red;font-weight:bold;':''}">${s.statusC || (s.chi?'X':'')}</td>
                <td style="${s.math?'color:blue;font-weight:bold;':''}">${s.statusM || (s.math?'X':'')}</td>
                <td style="${s.eng?'color:green;font-weight:bold;':''}">${s.statusE || (s.eng?'X':'')}</td>
                <td style="font-size:12px; color:#666;">${s.isCase ? 'éœ€æ–½æ¸¬' : ''}</td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        html += `<p style="text-align:right; font-size:12px; color:#666; margin-top:5px;">å…± ${globalStudents.length} ç­†è³‡æ–™</p>`;
        container.innerHTML = html;
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.navbar button').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        
        const btns = document.querySelectorAll('.navbar button');
        const map = { 'data':0, 'slips':1, 'idlist':2, 'stats':3, 'teachers':4, 'parent-notice-set':5, 'parent-notice-print':6, 'surveys-set':7, 'surveys-print':8 };
        if(map[id] !== undefined) btns[map[id]].classList.add('active');
    }

    function showPreview(htmlContent, className) {
        document.getElementById('config-panel').style.display = 'none';
        document.getElementById('preview-container').style.display = 'block';
        document.getElementById('preview-content').innerHTML = htmlContent;
        if(className) document.body.className = className;
        window.scrollTo(0,0);
    }

    function closePreview() {
        document.getElementById('config-panel').style.display = 'block';
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('preview-content').innerHTML = '';
        document.body.className = '';
    }

    // v49.1 æ–°å¢ï¼šåˆ—å°å‰æª¢æŸ¥è³‡æ–™
    function safePrint() {
        if(globalStudents.length === 0) {
            alert("âš ï¸ å°šæœªåŒ¯å…¥å­¸ç”Ÿè³‡æ–™ï¼Œç„¡æ³•åˆ—å°ã€‚\nè«‹å…ˆè‡³ã€Œè³‡æ–™åŒ¯å…¥ã€åˆ†é ä¸Šå‚³ Excel æª”æ¡ˆã€‚");
            switchTab('data');
            return;
        }
        window.print();
    }

    // v50.1: åŠ å…¥ç©ºå€¼åˆ¤æ–·ï¼Œé¿å…é¡¯ç¤ºã€Œåœ°é»ï¼šã€ç©ºå­—æ¨£
    function generateScheduleTable() {
        let rows = '';
        for(let i=1; i<=6; i++) {
            const dC = document.getElementById(`d-c-${i}`).value.trim();
            const lC = document.getElementById(`l-c-${i}`).value.trim();
            const dM = document.getElementById(`d-m-${i}`).value.trim();
            const lM = document.getElementById(`l-m-${i}`).value.trim();
            const dE = document.getElementById(`d-e-${i}`).value.trim();
            const lE = document.getElementById(`l-e-${i}`).value.trim();
            
            // v50.1 Logic: If empty, don't show anything.
            const contentC = (dC ? `<span class="sch-time">${dC}</span>` : '') + 
                             (lC ? `<span class="sch-loc">åœ°é»ï¼š${lC}</span>` : '');
                             
            const contentM = (dM ? `<span class="sch-time">${dM}</span>` : '') + 
                             (lM ? `<span class="sch-loc">åœ°é»ï¼š${lM}</span>` : '');
                             
            const contentE = (dE ? `<span class="sch-time">${dE}</span>` : '') + 
                             (lE ? `<span class="sch-loc">åœ°é»ï¼š${lE}</span>` : '');

            rows += `
            <tr>
                <td style="font-weight:bold;">${i}å¹´ç´š</td>
                <td>${contentC}</td>
                <td>${contentM}</td>
                <td>${contentE}</td>
            </tr>`;
        }
        return `
        <div style="background-color:white; color:black; padding:5px 0; margin:5px 0; border-top:1px solid #ccc; border-bottom:1px solid #ccc;">
            <div style="text-align:center; font-weight:bold; margin-bottom:5px; color:#333;">â–¼ å…¨æ ¡å„å¹´ç´šæ¸¬é©—æ™‚é–“èˆ‡åœ°é»ä¸€è¦½è¡¨ â–¼</div>
            <table class="schedule-table">
                <tr>
                    <th style="width:10%">å¹´ç´š</th>
                    <th style="width:30%">åœ‹èª</th>
                    <th style="width:30%">æ•¸å­¸</th>
                    <th style="width:30%">è‹±èª</th>
                </tr>
                ${rows}
            </table>
        </div>`;
    }

    // v46.2: ä½¿ç”¨ replace(/\n/g, '<br>') ä¾†ç·Šç¸®è¡Œè·
    // v49.2: ä¿®æ­£ç‚º "114å­¸å¹´åº¦"
    function renderParentNotices() {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        
        const title = document.getElementById('pn-title').value;
        const intro = document.getElementById('pn-intro').value.replace(/\r\n|\r|\n/g, '<br>');
        const reason = document.getElementById('pn-reason').value.replace(/\r\n|\r|\n/g, '<br>');
        
        const footer = document.getElementById('pn-footer').value;
        const replyTitle = document.getElementById('pn-reply-title').value;
        const replyDeadline = document.getElementById('pn-reply-deadline').value;
        
        const scheduleTable = generateScheduleTable();

        const targets = globalStudents.filter(s => s.isCase);
        if(targets.length===0) return alert('ç„¡ç¬¦åˆæ¢ä»¶å­¸ç”Ÿ');

        let html = '';
        targets.forEach(s => {
            const studentTable = `
            <div style="margin-top: 10px; font-weight: bold; text-align: center;">æœ¬æ¬¡é€šçŸ¥æ¸¬é©—è€ƒè©¦ç§‘ç›®ç‚ºï¼š</div>
            <table class="student-status-table">
                <tr>
                    <td class="status-header">å¹´ç´š</td>
                    <td class="status-header">ç­ç´š</td>
                    <td class="status-header">å§“å</td>
                    <td colspan="3" class="status-header" style="font-size: 11pt;">O: å…è€ƒ / X: æœ¬æ¬¡è¦è€ƒ / ç©ºç™½: æœªæ¸¬é©—å…è€ƒ</td>
                </tr>
                <tr>
                    <td>${s.grade}</td>
                    <td>${s.cls}</td>
                    <td>${s.name}</td>
                    <td>åœ‹</td>
                    <td>æ•¸</td>
                    <td>è‹±</td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: left; padding-left: 10px; font-size: 11pt;">è€ƒè©¦æ™‚é–“ï¼šè«‹å°ç…§ä¸Šè¡¨ï¼Œç•¶é€±æœƒæœ‰å€‹åˆ¥é€šçŸ¥å–®ã€‚</td>
                    <td style="font-weight:bold;">${s.statusC}</td>
                    <td style="font-weight:bold;">${s.statusM}</td>
                    <td style="font-weight:bold;">${s.statusE}</td>
                </tr>
            </table>
            `;

            html += `
            <div class="preview-page-wrapper">
                <div class="survey-sheet">
                    <div class="notice-content-compact">
                        <div class="survey-title" style="color:blue;">${title}</div>
                        <div style="margin-bottom:5px; font-weight:bold;">æ•¬æ„›çš„å®¶é•·ï¼š</div>
                        <div style="margin-bottom:5px;">
                            <div style="text-indent:2em; margin-bottom:2px;">æ‚¨å¥½ï¼${title.substring(0,9)}æœ¬æ ¡æˆé•·æ¸¬é©—è¦åŠƒå¦‚ä¸‹ï¼š</div>
                            <div>${intro}</div>
                        </div>
                        
                        <div style="margin-top:5px;">
                            <div style="font-weight:bold; margin-bottom:2px;">ç›®çš„èˆ‡åŸå› ï¼š</div>
                            <div>${reason}</div>
                        </div>

                        ${scheduleTable}
                        
                        ${studentTable}

                        <div style="text-align:right; margin-top:5px; font-size:12pt;">
                            ${footer}
                        </div>
                    </div>

                    <div class="cut-line"><span>è«‹ æ²¿ è™› ç·š æ’• ä¸‹ ç¹³ äº¤ --- ä¸Š æ–¹ è³‡ æ–™ å®¶ é•· è‡ª è¡Œ ç•™ å­˜</span></div>

                    <div style="text-align:center;">
                        <div style="font-size:14pt; margin-bottom:5px;">${s.grade}å¹´${s.cls}ç­ &nbsp;&nbsp; å­¸ç”Ÿï¼š${s.name}</div>
                        <div class="reply-title">${replyTitle}</div>
                        <div style="font-weight:bold; margin:10px 0; font-size:14pt;">${replyDeadline}</div>
                        <div style="font-size:16pt; margin-top:20px;">
                            å®¶é•·ç°½åï¼šã€ __________________ ã€‘ ______æœˆ______æ—¥ç°½
                        </div>
                    </div>
                </div>
            </div>`;
        });
        showPreview(html, 'print-surveys');
    }

    // --- å…¶ä»–æ¸²æŸ“å‡½æ•¸ä¿æŒä¸è®Š ---
    function renderSurveys() {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        const config = {
            year: document.getElementById('s-year').value,
            semester: document.getElementById('s-semester').value,
            date: document.getElementById('s-date').value,
            time: document.getElementById('s-time').value,
            loc: document.getElementById('s-loc').value,
            note: document.getElementById('s-note').value,
            deadline: document.getElementById('s-deadline').value,
            reasons: document.getElementById('s-reasons').value.split('\n').filter(l=>l.trim()).map(l=>`<p class="survey-indent">${l}</p>`).join(''),
            footer: document.getElementById('s-footer').value // v48.0
        };
        const targets = globalStudents.filter(s => s.isCase);
        if(targets.length===0) return alert('ç„¡ç¬¦åˆæ¢ä»¶å­¸ç”Ÿ');

        let html = '';
        targets.forEach(s => {
            html += `
            <div class="preview-page-wrapper">
                <div class="survey-sheet">
                    <div class="survey-top">
                        <div class="survey-title">${config.year}å­¸å¹´åº¦${config.semester}å­¸ç¿’æ‰¶åŠ©å¯¦æ–½æ–¹æ¡ˆèª¿æŸ¥è¡¨(åœ‹/æ•¸/è‹±)</div>
                        <div class="survey-body">
                            <p><b>â—‰ æ•¬æ„›çš„å®¶é•·ï¼š</b></p>
                            <p style="text-indent:2em;">æ‚¨å¥½ï¼${config.year}å­¸å¹´åº¦${config.semester}å­¸ç¿’æ‰¶åŠ©é–‹ç­èª²ç¨‹è¦åŠƒå¦‚ä¸‹ï¼š</p>
                            <p class="survey-indent">(ä¸€)æ—¥æœŸï¼šã€${config.date}ã€‘</p>
                            <p class="survey-indent">(äºŒ)æ™‚é–“ï¼šã€${config.time}ã€‘</p>
                            <p class="survey-indent">(ä¸‰)åœ°é»ï¼š${config.loc}${config.note}</p>
                            <p class="survey-indent">(å››)è¼”å°ç§‘ç›®ï¼šåœ‹ã€æ•¸ã€è‹±èª(æ¯ç­11äººä»¥ä¸‹)ã€‚</p>
                            <p class="survey-indent">(äº”)æœ¬èª¿æŸ¥è¡¨è«‹æ–¼ã€${config.deadline}ã€‘å‰äº¤äºˆå°å¸«</p>
                            <p class="survey-indent">(å…­)æœ¬èª²ç¨‹ç”±æ•™è‚²éƒ¨å°ˆæ¬¾è£œåŠ©ï¼Œå®Œå…¨å…è²»ã€‚</p>
                            <p class="survey-indent">(ä¸ƒ)ç‚ºå®‰å…¨èµ·è¦‹ï¼Œè«‹å®¶é•·è¦ªè‡ªåˆ°æ ¡æ¥é€å­©å­æ”¾å­¸ã€‚</p>
                            <p class="survey-indent">(å…«)ã€è«‹ç¢ºèªæœ‰ç„¡ç›¸é—œç¤¾åœ˜æˆ–è£œç¿’è¡å ‚ã€‘ï¼Œä»¥å…å½±éŸ¿å­¸ç”Ÿèˆ‡æˆèª²è€å¸«æº–å‚™èª²ç¨‹ç­‰ç›¸é—œæ¬Šç›Šã€‚</p>
                            <p style="margin-top:5px;"><b>â—‰ ç›®çš„èˆ‡åŸå› ï¼š</b></p>
                            ${config.reasons}
                            <p style="text-align:right; margin-top:5px;">${config.footer}</p>
                        </div>
                    </div>
                    <div class="cut-line"><span>è«‹ æ²¿ è™› ç·š æ’• ä¸‹ ç¹³ äº¤ --- ä¸Š æ–¹ è³‡ æ–™ å®¶ é•· è‡ª è¡Œ ç•™ å­˜</span></div>
                    <div class="survey-bottom">
                        <div class="reply-title">${config.year}å­¸å¹´åº¦${config.semester}ã€Œå­¸ç¿’æ‰¶åŠ©ï¼å¯¦æ–½æ–¹æ¡ˆã€å­¸ç¿’è¼”å°æ„é¡˜åŒæ„æ›¸</div>
                        <table class="std-table survey-table">
                            <colgroup><col style="width:10%"><col style="width:10%"><col style="width:15%"><col style="width:65%"></colgroup>
                            <tr><th>å¹´ç´š</th><th>ç­ç´š</th><th>å§“å</th><th>è«‹é¸æ“‡åƒåŠ ç­ç´š (å¯å¤šé¸ï¼Œç…§æ„é¡˜å„ªå…ˆåˆ†é…)</th></tr>
                            <tr>
                                <td>${s.grade}</td><td>${s.cls}</td><td>${s.name}</td>
                                <td rowspan="3" class="checkbox-cell">
                                    <div class="checkbox-row">â–¡ åƒåŠ ã€Œåœ‹èªç­ã€ï¼Œèƒ½è¦ªè‡ªæ¥é€å­©å­æ”¾å­¸</div>
                                    <div class="checkbox-row">â–¡ åƒåŠ ã€Œæ•¸å­¸ç­ã€ï¼Œèƒ½è¦ªè‡ªæ¥é€å­©å­æ”¾å­¸</div>
                                    <div class="checkbox-row">â–¡ åƒåŠ ã€Œè‹±èªç­ã€ï¼Œèƒ½è¦ªè‡ªæ¥é€å­©å­æ”¾å­¸</div>
                                    <div style="font-size:12px; color:#666;">(â€»åœ‹æ•¸å¯èƒ½æœƒå› ç‚ºäººæ•¸ä¸å¤ åˆç­)</div>
                                    <div style="margin-top:5px;">â–¡ ä¸åƒåŠ ï¼ŒåŸå› ï¼š_________________</div>
                                </td>
                            </tr>
                            <tr><td colspan="3" style="font-size:12px; background:#eee;">Oï¼šé€šé &nbsp; Xï¼šæœªé€šé &nbsp; ç©ºç™½ï¼šæœªè€ƒ</td></tr>
                            <tr>
                                <td class="split-cell">
                                    <div class="split-top">åœ‹</div>
                                    <div class="split-bottom">${s.statusC}</div>
                                </td>
                                <td class="split-cell">
                                    <div class="split-top">æ•¸</div>
                                    <div class="split-bottom">${s.statusM}</div>
                                </td>
                                <td class="split-cell">
                                    <div class="split-top">è‹±</div>
                                    <div class="split-bottom">${s.statusE}</div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align:left; padding:10px;">
                                    <div style="margin-bottom:10px;">å®¶é•·é€£çµ¡é›»è©± (ç·Šæ€¥è¯çµ¡ç”¨)ï¼š<span style="font-size:12pt;">(è‹¥ä¸åƒåŠ å…å¡«é›»è©±å¾Œä¸‹æ–¹ç°½åç¹³å›)</span></div>
                                    <div style="display:flex; justify-content:space-around;">
                                        <div style="display:flex; flex-direction:column; gap:5px;">
                                            <div>æ‰‹æ©Ÿ1ï¼š________________________</div>
                                            <div>ç¨±è¬‚ï¼š________________________</div>
                                        </div>
                                        <div style="display:flex; flex-direction:column; gap:5px;">
                                            <div>æ‰‹æ©Ÿ2ï¼š________________________</div>
                                            <div>ç¨±è¬‚ï¼š________________________</div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4" style="text-align:left; padding:15px; font-weight:bold;">
                                    <div>è«‹æ–¼ ${config.deadline} å‰äº¤äºˆå°å¸«å”åŠ©ç¹³äº¤è‡³æ•™å‹™è™•</div>
                                    <div style="text-align:right; margin-top:10px;">å®¶é•·ç°½åï¼šã€ __________________ ã€‘ ____æœˆ____æ—¥ç°½</div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>`;
        });
        showPreview(html, 'print-surveys');
    }

    function renderSlips() {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        const title = document.getElementById('slip-title').value;
        const subList = [];
        if(document.getElementById('p-chi').checked) subList.push('chi');
        if(document.getElementById('p-math').checked) subList.push('math');
        if(document.getElementById('p-eng').checked) subList.push('eng');
        let html = '';
        subList.forEach(sub => {
            globalStudents.forEach(s => {
                if(!s[sub]) return;
                const i = s.grade;
                const t = document.getElementById(sub=='chi'?`d-c-${i}`:sub=='math'?`d-m-${i}`:`d-e-${i}`).value;
                const l = document.getElementById(sub=='chi'?`l-c-${i}`:sub=='math'?`l-m-${i}`:`l-e-${i}`).value;
                const check = (k) => k==sub?'â– ':'â–¡';
                html += `
                <div class="preview-page-wrapper">
                    <div class="sheet-page" style="min-height:auto; height:auto; padding:10px;">
                        <div class="slip-container">
                            <div class="slip-header">${title}</div>
                            <table class="std-table">
                                <colgroup><col style="width:6%"><col style="width:6%"><col style="width:10%"><col style="width:18%"><col style="width:18%"><col style="width:12%"><col style="width:30%"></colgroup>
                                <tr><th>å¹´ç´š</th><th>ç­ç´š</th><th>å§“å</th><th>åœ°é»</th><th>æ™‚é–“</th><th>ç§‘ç›®</th><th>ç‰©å“</th></tr>
                                <tr>
                                    <td>${s.grade}</td><td>${s.cls}</td><td>${s.name}</td>
                                    <td class="text-red">${l}</td><td class="text-red">${t.replace(' ','<br>')}</td>
                                    <td style="text-align:left; padding-left:10px;">
                                        <div><span class="square">${check('chi')}</span>åœ‹èª</div>
                                        <div><span class="square">${check('math')}</span>æ•¸å­¸</div>
                                        <div><span class="square">${check('eng')}</span>è‹±èª</div>
                                    </td>
                                    <td style="text-align:center;">
                                        <div><span class="square">â– </span>é‰›ç­†ç›’</div>
                                        <div><span class="square">${sub=='eng'?'â– ':'â–¡'}</span>è€³æ©Ÿ</div>
                                        <span style="font-size:12px;">(å¦‚æœæœ‰,æ¯”è¼ƒè¡›ç”Ÿ)</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>`;
            });
        });
        showPreview(html, 'print-slips');
    }

    function renderStats() {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        const grades = {};
        let total = { stu:0, c:0, m:0, e:0 };
        globalStudents.forEach(s => {
            if(!grades[s.grade]) grades[s.grade] = { stu:0, c:0, m:0, e:0, classes:{} };
            const g = grades[s.grade];
            if(s.isCase) { g.stu++; total.stu++; }
            if(s.chi) { g.c++; total.c++; }
            if(s.math) { g.m++; total.m++; }
            if(s.eng) { g.e++; total.e++; }
            if(!g.classes[s.cls]) g.classes[s.cls] = { c:0, m:0, e:0 };
            if(s.chi) g.classes[s.cls].c++;
            if(s.math) g.classes[s.cls].m++;
            if(s.eng) g.classes[s.cls].e++;
        });

        let html = `
        <div class="preview-page-wrapper" style="width:210mm; background:white; padding:20mm;">
            <div style="border: 2px solid #d9534f; background-color: #f9d6d5; color: #a94442; padding: 10px; margin-bottom: 20px; font-weight: bold; text-align: center; font-size: 13pt;">
                å‚™è¨»ï¼šé€™è£¡çµ±è¨ˆæ²’æœ‰ç®—ç¯©é¸æ¸¬é©—é€šéä¸¦ä¸”æœªçµæ¡ˆçš„åŒå­¸ï¼Œå¦‚æœ‰éœ€è¦è«‹è‡ªè¡Œé¡å¤–é€²å»ç³»çµ±å‹¾é¸é¸è€ƒç§‘ç›®ã€‚
            </div>
            <h3 style="text-align:center;">(1) å…¨æ ¡çµ±è¨ˆç¸½è¡¨</h3>
            <table class="std-table">
                <tr><th>å¹´ç´š</th><th>å€‹æ¡ˆæ•¸</th><th>åœ‹èª</th><th>æ•¸å­¸</th><th>è‹±èª</th></tr>
                ${Object.keys(grades).sort().map(g=>`<tr><td>${g}</td><td class="stat-student-count">${grades[g].stu}</td><td class="stat-chi">${grades[g].c}</td><td class="stat-math">${grades[g].m}</td><td class="stat-eng">${grades[g].e}</td></tr>`).join('')}
                <tr class="stat-total-row"><td>ç¸½è¨ˆ</td><td>${total.stu}</td><td>${total.c}</td><td>${total.m}</td><td>${total.e}</td></tr>
            </table><br><br><h3 style="text-align:center;">(2) å„ç­ç´šç´°é …çµ±è¨ˆ</h3>`;

        Object.keys(grades).sort().forEach(g => {
            html += `<h4>ã€${g} å¹´ç´šã€‘</h4><table class="std-table"><tr><th>ç­ç´š</th><th>åœ‹</th><th>æ•¸</th><th>è‹±</th></tr>`;
            const clsData = grades[g].classes;
            let subT = { c:0, m:0, e:0 };
            Object.keys(clsData).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(c => {
                const d = clsData[c];
                if(d.c+d.m+d.e > 0) {
                    subT.c+=d.c; subT.m+=d.m; subT.e+=d.e;
                    html += `<tr><td>${c} ç­</td><td class="stat-chi">${d.c}</td><td class="stat-math">${d.m}</td><td class="stat-eng">${d.e}</td></tr>`;
                }
            });
            html += `<tr class="stat-total-row"><td>${g}å¹´ç´šç¸½è¨ˆ</td><td class="stat-chi">${subT.c}</td><td class="stat-math">${subT.m}</td><td class="stat-eng">${subT.e}</td></tr></table><br>`;
        });
        html += `</div>`;
        showPreview(html, 'print-stats');
    }

    function initTeacherSelector() {
        const div = document.getElementById('class-checkboxes');
        div.innerHTML = '';
        const map = new Set();
        globalStudents.forEach(s => map.add(`${s.grade}-${s.cls}`));
        Array.from(map).sort((a,b) => parseInt(a.split('-')[0])-parseInt(b.split('-')[0]) || parseInt(a.split('-')[1])-parseInt(b.split('-')[1])).forEach(item => {
            div.innerHTML += `<label style="margin-right:10px;"><input type="checkbox" class="cls-cb" value="${item}"> ${item.replace('-','å¹´')}ç­</label>`;
        });
    }
    function toggleAllGrades(v) { document.querySelectorAll('.cls-cb').forEach(c=>c.checked=v); }

    function renderTeachers(pageBreak) {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        const cbs = document.querySelectorAll('.cls-cb:checked');
        if(cbs.length===0) return alert('è«‹å…ˆå‹¾é¸ç­ç´š');
        let html = pageBreak ? '' : '<div class="teacher-compact-container">';
        cbs.forEach(cb => {
            const [g, c] = cb.value.split('-');
            const stus = globalStudents.filter(s => s.grade==g && s.cls==c && (s.chi||s.math||s.eng));
            if(stus.length>0) {
                let cnt = {c:0, m:0, e:0};
                stus.forEach(s => { if(s.chi) cnt.c++; if(s.math) cnt.m++; if(s.eng) cnt.e++; });
                const i = g;
                const dC=document.getElementById(`d-c-${i}`).value, lC=document.getElementById(`l-c-${i}`).value;
                const dM=document.getElementById(`d-m-${i}`).value, lM=document.getElementById(`l-m-${i}`).value;
                const dE=document.getElementById(`d-e-${i}`).value, lE=document.getElementById(`l-e-${i}`).value;
                const wrapperStart = pageBreak ? '<div class="preview-page-wrapper">' : '';
                const wrapperEnd = pageBreak ? '</div>' : '';
                const style = pageBreak ? 'page-break-after:always; padding:10mm; background:white; width:210mm; min-height:297mm;' : 'margin-bottom:20px;';
                html += `${wrapperStart}<div style="${style}"><div class="teacher-header" style="background:#333; color:white; padding:5px; font-weight:bold; display:flex; justify-content:space-between;"><span>${g}å¹´${c}ç­ (å°å¸«ç•™å­˜)</span><span style="font-size:12pt;">åœ‹:${cnt.c} æ•¸:${cnt.m} è‹±:${cnt.e}</span></div><table class="std-table teacher-table" style="font-size:10pt;"><tr><th style="width:5%">åº§è™Ÿ</th><th style="width:10%">å§“å</th><th style="width:5%">åœ‹</th><th style="width:5%">æ•¸</th><th style="width:5%">è‹±</th><th style="width:23%">åœ‹è€ƒè³‡è¨Š</th><th style="width:23%">æ•¸è€ƒè³‡è¨Š</th><th style="width:23%">è‹±è€ƒè³‡è¨Š</th></tr>${stus.map(s=>`<tr><td>${s.seat}</td><td>${s.name}</td><td>${s.chi?'â—':''}</td><td>${s.math?'â—':''}</td><td>${s.eng?'â—':''}</td><td class="info-cell">${s.chi?dC+'<br>'+lC:''}</td><td class="info-cell">${s.math?dM+'<br>'+lM:''}</td><td class="info-cell">${s.eng?dE+'<br>'+lE:''}</td></tr>`).join('')}</table>${!pageBreak?'<div class="teacher-break-line"></div>':''}</div>${wrapperEnd}`;
            }
        });
        if(!pageBreak) html += '</div>';
        showPreview(html, pageBreak?'print-teachers':'print-teachers-compact');
    }

    function renderCheckList() {
        if(globalStudents.length===0) return alert('ç„¡è³‡æ–™');
        const showChi = document.getElementById('sign-chi').checked;
        const showMath = document.getElementById('sign-math').checked;
        const showEng = document.getElementById('sign-eng').checked;
        if(!showChi && !showMath && !showEng) return alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç§‘ç›®');
        let html = '';
        const create = (code, name) => {
            const targets = globalStudents.filter(s => s[code]);
            if(targets.length === 0) return '';
            return `<div class="preview-page-wrapper"><div class="sheet-page"><h2 style="text-align:center;">æ¸¬é©—ç°½åˆ°è¡¨ (${name}å°ˆç”¨)</h2><table class="std-table"><tr><th style="width:5%">åºè™Ÿ</th><th style="width:10%">å¹´ç´š</th><th style="width:10%">ç­ç´š</th><th style="width:10%">åº§è™Ÿ</th><th style="width:15%">å§“å</th><th style="width:20%">èº«åˆ†è­‰</th><th style="width:15%">${name}</th><th style="width:15%">å ±åˆ°æ‰“å‹¾</th></tr>${targets.map((s, idx)=>`<tr><td>${idx+1}</td><td>${s.grade}</td><td>${s.cls}</td><td>${s.seat}</td><td>${s.name}</td><td style="font-family:monospace;">${s.idNo}</td><td>â—</td><td><span style="font-size:20px;">â–¡</span></td></tr>`).join('')}</table></div></div>`;
        };
        if(showChi) html += create('chi', 'åœ‹èª');
        if(showMath) html += create('math', 'æ•¸å­¸');
        if(showEng) html += create('eng', 'è‹±èª');
        if(html === '') return alert('é¸å®šçš„ç§‘ç›®æ²’æœ‰å­¸ç”Ÿéœ€è¦è€ƒè©¦');
        showPreview(html, 'print-list');
    }

    init();
</script>

</body>
</html>
