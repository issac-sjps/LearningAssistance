<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ‰¶åŠ©æ¸¬é©—ç®¡ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background-color: #f4f4f4; }
        
        /* é ‚éƒ¨å°èˆªåˆ— */
        .navbar {
            background-color: #333;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { margin: 0; font-size: 20px; }
        .nav-tabs button {
            background: none;
            border: none;
            color: #ddd;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }
        .nav-tabs button.active {
            color: white;
            border-bottom: 3px solid #4CAF50;
            font-weight: bold;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* è¨­å®šå€å¡Š */
        .settings-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .config-row { margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .config-row label { width: 60px; font-weight: bold; }
        input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; margin-right: 5px;}
        .btn-blue { background-color: #007bff; }
        .btn-green { background-color: #28a745; }
        .btn-red { background-color: #dc3545; }
        .btn-gray { background-color: #6c757d; }
        .btn:hover { opacity: 0.9; }

        /* è³‡æ–™è¡¨æ ¼æ¨£å¼ */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .data-table th { background-color: #f2f2f2; }
        .data-table tr:hover { background-color: #f1f1f1; }

        /* åˆ†é¡éæ¿¾æŒ‰éˆ•å€ */
        .filter-bar { margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ----- æ˜æ¢åˆ—å°æ¨£å¼ (èˆ‡ä¹‹å‰ç›¸åŒ) ----- */
        .slip-container {
            width: 100%; max-width: 800px; background: white;
            padding: 10px 0; page-break-inside: avoid; margin-bottom: 20px; border-bottom: 1px dashed #ccc;
        }
        .slip-title { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 5px; font-family: "æ¨™æ¥·é«”"; }
        table.slip-table { width: 100%; border-collapse: collapse; border: 1px solid black; text-align: center; font-family: "æ¨™æ¥·é«”"; }
        .slip-table th, .slip-table td { border: 1px solid black; padding: 5px; vertical-align: middle; font-size: 18px; }
        .slip-table th { height: 40px; font-weight: normal; }
        .slip-table td { height: 80px; }
        .text-red { color: red; font-weight: bold; }
        .text-left { text-align: left; padding-left: 15px; }
        .checkbox-item { display: block; margin: 3px 0; text-align: left; margin-left: 10px; }
        .square { display: inline-block; width: 14px; height: 14px; line-height: 14px; margin-right: 5px; }

        /* åˆ—å°æ¨¡å¼ */
        @media print {
            .navbar, .settings-box, .btn-section, .filter-bar, #tab-data { display: none !important; }
            .container { box-shadow: none; margin: 0; padding: 0; max-width: 100%; }
            .tab-content { display: block; } /* å¼·åˆ¶é¡¯ç¤ºå…§å®¹ */
            #tab-preview { display: block !important; } /* åªé¡¯ç¤ºé è¦½å€ */
            body { background: white; }
            .slip-container { border-bottom: 1px dashed #999; margin-bottom: 0; padding: 20px 0; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <h1>æ¸¬é©—é€šçŸ¥å–®ç³»çµ±</h1>
        <div class="nav-tabs">
            <button class="active" onclick="switchTab('data')">1. è³‡æ–™ç®¡ç†èˆ‡ç¯©é¸</button>
            <button onclick="switchTab('preview')">2. åˆ—å°é è¦½ (ç”¢ç”Ÿæ˜æ¢)</button>
        </div>
    </div>

    <div class="container">
        <div class="settings-box">
            <h3 style="margin-top:0">ç¬¬ä¸€æ­¥ï¼šåŒ¯å…¥èˆ‡è¨­å®š</h3>
            <input type="file" id="uploadFile" accept=".csv, .xlsx, .xls" />
            <span style="color: #666; font-size: 14px; margin-left: 10px;">(è«‹ä¸Šå‚³å«æœ‰ å¹´ç´šã€ç­ç´šã€å§“åã€ç§‘ç›® çš„ Excel)</span>
        </div>

        <div id="tab-data" class="tab-content active">
            <div class="filter-bar">
                <strong>æª¢è¦–ç¯©é¸ï¼š</strong>
                <button class="btn btn-gray" onclick="renderTable('all')">é¡¯ç¤ºç¸½è¡¨ (å¯åˆªé™¤)</button>
                <button class="btn btn-blue" onclick="renderTable('chi')">åªçœ‹åœ‹èª</button>
                <button class="btn btn-blue" onclick="renderTable('math')">åªçœ‹æ•¸å­¸</button>
                <button class="btn btn-blue" onclick="renderTable('eng')">åªçœ‹è‹±èª</button>
                
                <button class="btn btn-green" style="float: right;" onclick="exportExcel()">åŒ¯å‡ºç›®å‰åå–® (Excel)</button>
            </div>
            
            <div id="table-container">
                <p style="text-align: center; color: #888; padding: 20px;">è«‹å…ˆä¸Šå‚³æª”æ¡ˆä»¥æª¢è¦–è³‡æ–™ã€‚</p>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <div class="settings-box">
                <h3 style="margin-top:0">ç¬¬äºŒæ­¥ï¼šè¨­å®šå„å¹´ç´šè€ƒè©¦è³‡è¨Š</h3>
                <div id="grade-settings"></div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-blue" onclick="generateSlips()">æ›´æ–°/ç”¢ç”Ÿæ˜æ¢</button>
                    <button class="btn btn-green" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                </div>
            </div>
            <div id="slips-area"></div>
        </div>
    </div>

<script>
    // å…¨åŸŸè®Šæ•¸å„²å­˜è³‡æ–™
    let globalStudents = []; 

    // åˆå§‹åŒ–å¹´ç´šè¨­å®šæ¬„ä½
    const gradeSettingsContainer = document.getElementById('grade-settings');
    for (let i = 1; i <= 6; i++) {
        const div = document.createElement('div');
        div.className = 'config-row';
        div.innerHTML = `
            <label>${i} å¹´ç´š</label>
            <input type="text" id="loc-${i}" placeholder="æ¸¬é©—åœ°é»" value="3F-E åŒ–æ•™å®¤" style="width: 150px;">
            <input type="text" id="date-${i}" placeholder="æ—¥æœŸ" value="12/2(äºŒ) æ—©è‡ªä¿®" style="width: 150px;">
            <input type="text" id="time-${i}" placeholder="æ™‚é–“" value="7:50~8:30" style="width: 120px;">
        `;
        gradeSettingsContainer.appendChild(div);
    }

    // æª”æ¡ˆä¸Šå‚³ç›£è½
    document.getElementById('uploadFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            
            // è³‡æ–™æ­£è¦åŒ– (æ•´ç†æˆçµ±ä¸€æ ¼å¼)
            globalStudents = rawData.map((row, index) => {
                return {
                    id: index, // çµ¦äºˆå”¯ä¸€ ID æ–¹ä¾¿åˆªé™¤
                    grade: (row['ç›®å‰å¹´ç´š'] || row['å¹´ç´š'] || '').toString().trim(),
                    cls: (row['ç­ç´š'] || '').toString().trim(),
                    name: (row['å§“å'] || '').toString().trim(),
                    // åˆ¤æ–·æ˜¯å¦æœ‰å€¼ (æœ‰å€¼å°±ä»£è¡¨è¦è€ƒ)
                    chi: (row['åœ‹èªæ–‡æ¸¬é©—'] || row['åœ‹èª'] || '').toString().trim(),
                    math: (row['æ•¸å­¸æ¸¬é©—'] || row['æ•¸å­¸'] || '').toString().trim(),
                    eng: (row['è‹±èªæ¸¬é©—'] || row['è‹±èª'] || '').toString().trim(),
                    // ä¿ç•™åŸå§‹ç‰©ä»¶ä»¥ä¾¿éœ€è¦æ™‚æŸ¥çœ‹å…¶ä»–æ¬„ä½
                    raw: row
                };
            });

            alert(`æˆåŠŸåŒ¯å…¥ ${globalStudents.length} ç­†è³‡æ–™`);
            renderTable('all'); // é è¨­é¡¯ç¤ºç¸½è¡¨
        };
        reader.readAsArrayBuffer(file);
    });

    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
        
        if (tabName === 'data') {
            document.getElementById('tab-data').classList.add('active');
            document.querySelector('.nav-tabs button:nth-child(1)').classList.add('active');
        } else {
            document.getElementById('tab-preview').classList.add('active');
            document.querySelector('.nav-tabs button:nth-child(2)').classList.add('active');
            generateSlips(); // åˆ‡æ›åˆ°é è¦½æ™‚è‡ªå‹•ç”¢ç”Ÿ
        }
    }

    // æ¸²æŸ“è³‡æ–™è¡¨æ ¼
    function renderTable(filterType) {
        const container = document.getElementById('table-container');
        let filteredData = [];
        let title = "";

        // æ ¹æ“šé¡å‹ç¯©é¸
        if (filterType === 'all') {
            filteredData = globalStudents;
            title = "ç¸½è¡¨ (å…¨éƒ¨å­¸ç”Ÿ)";
        } else if (filterType === 'chi') {
            filteredData = globalStudents.filter(s => s.chi.length > 0);
            title = "åœ‹èªæ–‡æ¸¬é©—åå–®";
        } else if (filterType === 'math') {
            filteredData = globalStudents.filter(s => s.math.length > 0);
            title = "æ•¸å­¸æ¸¬é©—åå–®";
        } else if (filterType === 'eng') {
            filteredData = globalStudents.filter(s => s.eng.length > 0);
            title = "è‹±èªæ¸¬é©—åå–®";
        }

        if (filteredData.length === 0) {
            container.innerHTML = `<h4>${title}ï¼šç›®å‰æ²’æœ‰è³‡æ–™</h4>`;
            return;
        }

        let html = `<h4>${title} (å…± ${filteredData.length} äºº)</h4>`;
        html += `<table class="data-table"><thead><tr>
            <th>å¹´ç´š</th><th>ç­ç´š</th><th>å§“å</th>
            <th>åœ‹èª</th><th>æ•¸å­¸</th><th>è‹±èª</th>
            ${filterType === 'all' ? '<th>æ“ä½œ</th>' : ''}
        </tr></thead><tbody>`;

        filteredData.forEach(s => {
            html += `<tr>
                <td>${s.grade}</td>
                <td>${s.cls}</td>
                <td>${s.name}</td>
                <td>${s.chi ? 'âœ…' : ''}</td>
                <td>${s.math ? 'âœ…' : ''}</td>
                <td>${s.eng ? 'âœ…' : ''}</td>
                ${filterType === 'all' ? `<td><button class="btn btn-red" onclick="deleteStudent(${s.id})">åˆªé™¤</button></td>` : ''}
            </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // åˆªé™¤å­¸ç”Ÿ
    function deleteStudent(id) {
        if (!confirm("ç¢ºå®šè¦å°‡é€™ä½å­¸ç”Ÿå¾åå–®ä¸­ç§»é™¤å—ï¼Ÿ")) return;
        
        // å¾ globalStudents ä¸­ç§»é™¤
        globalStudents = globalStudents.filter(s => s.id !== id);
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderTable('all');
    }

    // åŒ¯å‡º Excel
    function exportExcel() {
        if (globalStudents.length === 0) { alert("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º"); return; }

        // å°‡è³‡æ–™è½‰æ›å› Excel æ ¼å¼
        const exportData = globalStudents.map(s => ({
            "å¹´ç´š": s.grade,
            "ç­ç´š": s.cls,
            "å§“å": s.name,
            "åœ‹èªæ–‡æ¸¬é©—": s.chi, // ä¿ç•™åŸå§‹æ¨™è¨˜ (ä¾‹å¦‚ X)
            "æ•¸å­¸æ¸¬é©—": s.math,
            "è‹±èªæ¸¬é©—": s.eng
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æœ€æ–°åå–®");
        XLSX.writeFile(wb, "æ•´ç†å¾Œåå–®.xlsx");
    }

    // ç”¢ç”Ÿæ˜æ¢ (åˆ—å°ç”¨)
    function generateSlips() {
        const container = document.getElementById('slips-area');
        container.innerHTML = '';

        if (globalStudents.length === 0) {
            container.innerHTML = '<p style="text-align:center">è«‹å…ˆåŒ¯å…¥è³‡æ–™ã€‚</p>';
            return;
        }

        globalStudents.forEach(s => {
            // å–å¾—è©²å¹´ç´šè¨­å®š
            let loc = "æœªè¨­å®š";
            let date = "";
            let time = "";
            const locInput = document.getElementById(`loc-${s.grade}`);
            if (locInput) {
                loc = locInput.value;
                date = document.getElementById(`date-${s.grade}`).value;
                time = document.getElementById(`time-${s.grade}`).value;
            }

            const isChinese = s.chi.length > 0;
            const isMath = s.math.length > 0;
            const isEnglish = s.eng.length > 0;

            const slipHTML = `
                <div class="slip-container">
                    <div class="slip-title">æ•™è‚²éƒ¨-æ–°èŠåœ‹å°-å­¸ç¿’æ‰¶åŠ©-æˆé•·æ¸¬é©— (è«‹å”åŠ©è²¼æ–½æ¸¬ç•¶é€±è¯çµ¡ç°¿)</div>
                    <table class="slip-table">
                        <thead>
                            <tr>
                                <th style="width: 8%;">å¹´ç´š</th>
                                <th style="width: 8%;">ç­ç´š</th>
                                <th style="width: 15%;">å§“å</th>
                                <th style="width: 20%;">æ–½æ¸¬åœ°é»</th>
                                <th style="width: 20%;">æ–½æ¸¬æ—¥æœŸèˆ‡æ™‚é–“</th>
                                <th style="width: 15%;">æ¸¬é©—ç§‘ç›®</th>
                                <th>å»ºè­°æ”œå¸¶ç‰©å“</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${s.grade}</td>
                                <td>${s.cls}</td>
                                <td>${s.name}</td>
                                <td class="text-red">${loc}</td>
                                <td class="text-red">${date}<br>${time}</td>
                                <td class="text-left">
                                    <div class="checkbox-item"><span class="square">${isChinese ? 'â– ' : 'â–¡'}</span>åœ‹èª</div>
                                    <div class="checkbox-item"><span class="square">${isMath ? 'â– ' : 'â–¡'}</span>æ•¸å­¸</div>
                                    <div class="checkbox-item"><span class="square">${isEnglish ? 'â– ' : 'â–¡'}</span>è‹±èª</div>
                                </td>
                                <td class="text-left" style="font-size: 16px;">
                                    <div class="checkbox-item"><span class="square">â– </span>é‰›ç­†ç›’</div>
                                    <div class="checkbox-item"><span class="square">${isEnglish ? 'â– ' : 'â–¡'}</span>è‹±è½ç”¨è€³æ©Ÿ<br><span style="font-size:14px; margin-left:22px">(å¦‚æœæœ‰,æ¯”è¼ƒè¡›ç”Ÿ)</span></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', slipHTML);
        });
    }
</script>

</body>
</html>
