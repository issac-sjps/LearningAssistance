<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç¿’æ‰¶åŠ©ç·¨ç­ç³»çµ± (V16.0 15ç­å¯¬è¢å¹•ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; }
            body { background: white; }
            .page-break { page-break-after: always; }
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .print-area { display: none; }
        
        .notice-box {
            border: 2px solid black; padding: 20px; margin-bottom: 20px;
            font-family: "BiauKai", "DFKai-SB", serif; font-size: 16px; line-height: 1.5; max-width: 800px; margin: 0 auto;
        }
        .notice-header { text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .cut-line { border-top: 1px dashed black; margin: 20px 0; text-align: center; position: relative; }
        .cut-line span { background: white; padding: 0 10px; position: relative; top: -12px; font-size: 14px;}

        .student-card {
            background: white; border-left: 4px solid #ddd; padding: 8px; margin: 5px;
            border-radius: 4px; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            user-select: none; font-size: 14px; transition: all 0.2s;
        }
        .student-card:active { cursor: grabbing; }
        .student-meta { font-size: 12px; color: #666; display: flex; justify-content: space-between;}
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        .class-drag-handle { cursor: move; color: #9ca3af; padding: 0 5px; }
        .class-drag-handle:hover { color: #4b5563; }

        .quick-assign-select { font-size: 12px; margin-top: 4px; padding: 2px; width: 100%; border: 1px solid #ccc; border-radius: 3px; background-color: #f9fafb; }
        .settings-table th { background-color: #f3f4f6; padding: 10px; border: 1px solid #e5e7eb; text-align: left; white-space: nowrap; }
        .settings-table td { padding: 4px; border: 1px solid #e5e7eb; }
        .settings-table input, .settings-table select { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; }
        
        .scan-item:hover { background-color: #eff6ff; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans flex flex-col">

    <div class="no-print max-w-full mx-auto w-full bg-white shadow-md rounded-lg p-3 mb-4 sticky top-0 z-50 px-6">
        <div class="flex justify-between items-center flex-wrap gap-3">
            <h1 class="text-xl font-bold text-gray-800 flex items-center shrink-0">
                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-2">V16.0</span>
                å­¸ç¿’æ‰¶åŠ©ç·¨ç­ç³»çµ±
                <span id="save-status" class="ml-2 text-xs font-normal text-gray-400"></span>
            </h1>
            <div class="space-x-1 text-sm shrink-0 flex overflow-x-auto">
                <button onclick="switchTab('scan')" class="px-3 py-1.5 bg-blue-500 text-white rounded hover:bg-blue-600 transition shadow-sm whitespace-nowrap">1. å­¸ç”Ÿç™»éŒ„</button>
                <button onclick="switchTab('class-settings')" class="px-3 py-1.5 bg-orange-500 text-white rounded hover:bg-orange-600 transition shadow-sm whitespace-nowrap">2. ç­ç´šè¨­å®š</button>
                <button onclick="switchTab('arrange')" class="px-3 py-1.5 bg-green-500 text-white rounded hover:bg-green-600 transition shadow-sm whitespace-nowrap">3. æ‹–æ›³ç·¨ç­</button>
                <button onclick="switchTab('print')" class="px-3 py-1.5 bg-purple-500 text-white rounded hover:bg-purple-600 transition shadow-sm whitespace-nowrap">4. åˆ—å°èˆ‡åŒ¯å‡º</button>
            </div>
        </div>
    </div>

    <div id="scan-section" class="no-print w-full max-w-6xl mx-auto bg-white p-6 rounded-lg shadow show-section">
        <div class="flex gap-6 flex-col md:flex-row">
            <div class="md:w-1/3 border-2 border-blue-200 rounded-lg p-5 bg-blue-50">
                <h3 class="font-bold text-blue-800 mb-4 text-lg">ğŸ“ æ‰‹å‹•æ–°å¢å­¸ç”Ÿå›æ¢</h3>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <input type="number" id="mGrade" placeholder="å¹´ç´š" class="border p-2 rounded w-1/2 focus:outline-blue-500">
                        <input type="number" id="mClass" placeholder="ç­ç´š" class="border p-2 rounded w-1/2 focus:outline-blue-500">
                    </div>
                    <input type="text" id="mName" placeholder="å­¸ç”Ÿå§“å" class="border p-2 rounded w-full focus:outline-blue-500">
                    <div class="bg-white p-3 rounded border">
                        <p class="text-sm text-gray-500 mb-2">å‹¾é¸åƒåŠ ç­ç´š (å¯å¤šé¸)ï¼š</p>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" name="mSub" value="åœ‹èª" class="w-5 h-5 text-blue-600 mr-2 accent-red-500"><span class="font-bold text-red-600">åœ‹èªç­</span></label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" name="mSub" value="æ•¸å­¸" class="w-5 h-5 text-blue-600 mr-2 accent-blue-500"><span class="font-bold text-blue-600">æ•¸å­¸ç­</span></label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" name="mSub" value="è‹±èª" class="w-5 h-5 text-blue-600 mr-2 accent-green-500"><span class="font-bold text-green-600">è‹±èªç­</span></label>
                        </div>
                    </div>
                    <button onclick="manualAdd()" class="bg-blue-600 text-white font-bold w-full py-3 rounded shadow hover:bg-blue-700 transition">+ åŠ å…¥æ¸…å–®</button>
                    <hr class="border-blue-200 my-2">
                    <button onclick="mockScanNewForm()" class="bg-gray-400 text-white text-xs w-full py-2 rounded hover:bg-gray-500">âš¡ è¼‰å…¥æ¸¬è©¦ç¯„ä¾‹</button>
                </div>
            </div>
            <div class="md:w-2/3">
                <div class="flex justify-between items-center mb-2 bg-gray-100 p-2 rounded">
                    <h3 class="font-bold text-gray-700">å·²ç™»éŒ„åå–® <span class="text-xs font-normal text-gray-500">(é»å…©ä¸‹å¯ç·¨è¼¯)</span></h3>
                    <div class="flex items-center gap-2">
                        <button onclick="sortRegisteredList()" class="bg-blue-500 text-white text-xs px-3 py-1.5 rounded hover:bg-blue-600 shadow-sm flex items-center">ğŸ”½ ä¾ç­ç´šæ’åº</button>
                        <span id="count-badge" class="bg-gray-300 text-gray-700 text-xs px-2 py-1.5 rounded font-bold">0 äºº</span>
                    </div>
                </div>
                <div id="scanned-list" class="h-[450px] overflow-y-auto border p-2 rounded bg-gray-50 space-y-2">
                    <p class="text-gray-400 text-center mt-20">è«‹åœ¨å·¦å´è¼¸å…¥å›æ¢è³‡æ–™</p>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-gray-800">ç·¨è¼¯å­¸ç”Ÿè³‡æ–™</h3>
            <input type="hidden" id="edit-id">
            <div class="mb-3 flex gap-2">
                <div class="w-1/2"><label class="block text-xs text-gray-500 mb-1">å¹´ç´š</label><input type="number" id="edit-grade" class="w-full border p-2 rounded"></div>
                <div class="w-1/2"><label class="block text-xs text-gray-500 mb-1">åŸç­ç´š</label><input type="number" id="edit-class" class="w-full border p-2 rounded"></div>
            </div>
            <div class="mb-3"><label class="block text-xs text-gray-500 mb-1">å§“å</label><input type="text" id="edit-name" class="w-full border p-2 rounded"></div>
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-2">åƒåŠ ç§‘ç›®</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="checkbox" id="edit-sub-chi" value="åœ‹èª" class="mr-1"> åœ‹èª</label>
                    <label class="flex items-center"><input type="checkbox" id="edit-sub-math" value="æ•¸å­¸" class="mr-1"> æ•¸å­¸</label>
                    <label class="flex items-center"><input type="checkbox" id="edit-sub-eng" value="è‹±èª" class="mr-1"> è‹±èª</label>
                </div>
            </div>
            <div class="flex justify-end gap-2 border-t pt-3">
                <button onclick="closeEditModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="saveEdit()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <div id="class-settings-section" class="no-print w-full max-w-7xl mx-auto bg-white p-6 rounded-lg shadow hidden flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <div><h2 class="text-xl font-bold text-gray-800">ç­ç´šè©³ç´°è³‡æ–™è¨­å®š</h2><p class="text-sm text-gray-500">è¨­å®šç­ç´šèˆ‡æ•™å®¤è³‡è¨Šã€‚</p></div>
            <button onclick="addNewClassRow()" class="bg-orange-500 text-white px-4 py-2 rounded shadow hover:bg-orange-600">+ æ–°å¢ç­ç´š</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse settings-table text-sm">
                <thead><tr><th class="w-16">ç­åˆ¥</th><th class="w-16">å¹´ç´š</th><th class="w-24">ç§‘ç›®</th><th class="w-24">æ•™å¸«å§“å</th><th class="w-20">åˆ†æ©Ÿ</th><th>æ•™å®¤ä»£è™Ÿ</th><th>æ¨“-é–“</th><th>æ•™å®¤åç¨±</th><th class="w-16 text-center">æ“ä½œ</th></tr></thead>
                <tbody id="class-settings-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="arrange-section" class="no-print w-full hidden flex-1 overflow-hidden" style="height: 80vh;">
        <div class="w-64 flex-shrink-0 flex flex-col h-full bg-white border-r border-gray-300 shadow-md z-10">
            <div class="bg-gray-700 text-white p-2 text-center font-bold text-lg shadow relative">å¾…åˆ†ç™¼åå–®</div>
            <div class="bg-gray-100 p-2 flex gap-1 justify-center border-b border-gray-300">
                <button onclick="sortPool('grade')" class="bg-white border text-xs px-2 py-1 rounded hover:bg-gray-200 flex-1">ğŸ”½ å¹´ç´šæ’åº</button>
                <button onclick="sortPool('subject')" class="bg-white border text-xs px-2 py-1 rounded hover:bg-gray-200 flex-1">ğŸ”½ ç§‘ç›®æ’åº</button>
            </div>
            <div id="unassigned-pool" class="flex-1 p-2 bg-gray-100 overflow-y-auto" data-class-id="null"></div>
        </div>
        <div class="flex-1 flex flex-col h-full bg-gray-50">
            <div class="flex justify-between items-center p-3 bg-white border-b shadow-sm sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-bold text-gray-700">ç·¨ç­ä½œæ¥­å€</h2>
                    <div class="flex items-center gap-2 text-xs bg-gray-100 px-3 py-1 rounded-full border">
                        <span class="w-2 h-2 rounded-full bg-red-500"></span>åœ‹èª
                        <span class="w-2 h-2 rounded-full bg-blue-500 ml-2"></span>æ•¸å­¸
                        <span class="w-2 h-2 rounded-full bg-green-500 ml-2"></span>è‹±èª
                    </div>
                </div>
                <div class="text-sm text-gray-500">ğŸ’¡ æ‹–æ›³å¡ç‰‡å·¦ä¸Šè§’ <span class="font-bold text-lg">âœ¥</span> å¯äº’æ›ç­ç´šé †åº (åç¨±å›ºå®š)</div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div id="classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 pb-10"></div>
            </div>
        </div>
    </div>

    <div id="print-section" class="no-print max-w-6xl mx-auto bg-white p-6 rounded-lg shadow hidden">
        <h2 class="text-xl font-bold mb-4 border-b pb-2">åˆ—å°èˆ‡åŒ¯å‡º</h2>
        <div class="mb-6 bg-slate-100 p-4 rounded-lg border-2 border-slate-300">
            <h3 class="font-bold text-slate-800 text-lg mb-2 flex items-center"><span class="mr-2">ğŸ’¾</span> ç³»çµ±è³‡æ–™è½‰ç§»</h3>
            <div class="flex gap-4">
                <button onclick="exportSystemBackup()" class="flex-1 bg-slate-600 text-white font-bold py-3 rounded shadow hover:bg-slate-700 transition flex justify-center items-center"><span class="mr-2">â¬‡ï¸</span> åŒ¯å‡ºå‚™ä»½ (.json)</button>
                <div class="flex-1 relative">
                    <input type="file" id="systemRestoreInput" accept=".json" class="hidden" onchange="importSystemBackup(this)">
                    <button onclick="document.getElementById('systemRestoreInput').click()" class="w-full h-full bg-white border-2 border-slate-400 text-slate-700 font-bold py-3 rounded shadow hover:bg-slate-50 transition flex justify-center items-center"><span class="mr-2">â¬†ï¸</span> é‚„åŸå‚™ä»½</button>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-purple-50 p-5 rounded border border-purple-200">
                <h3 class="font-bold text-purple-800 mb-3 text-lg">ğŸ“„ é€šçŸ¥å–®å…§å®¹è¨­å®š</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-sm font-bold text-gray-700">é€šçŸ¥å–®æ¨™é¡Œ</label><input type="text" id="setting-title" value="æ–°èŠåœ‹å° 114 å­¸å¹´åº¦ä¸Šå­¸æœŸå­¸ç¿’æ‰¶åŠ©ä¸Šèª²é€šçŸ¥å–®" class="w-full border p-2 rounded" onchange="saveData()"></div>
                    <div><label class="block text-sm font-bold text-gray-700">ä¸Šèª²æ—¥æœŸ</label><input type="text" id="setting-date" value="9/22(ä¸€)~12/29(ä¸€)" class="w-full border p-2 rounded" onchange="saveData()"></div>
                    <div><label class="block text-sm font-bold text-gray-700">ä¸Šèª²æ™‚é–“</label><input type="text" id="setting-time" value="æ¯é€±ä¸€ã€é€±å›› 16:00-17:30" class="w-full border p-2 rounded" onchange="saveData()"></div>
                    <div><label class="block text-sm font-bold text-gray-700">å›æ¢ç¹³å›æœŸé™</label><input type="text" id="setting-deadline" value="9/22(ä¸€)" class="w-full border p-2 rounded" onchange="saveData()"></div>
                    <div><label class="block text-sm font-bold text-gray-700">åˆ†æ©Ÿé è¨­å‰ç¶´</label><input type="text" disabled value="3411373#" class="w-full border p-2 rounded bg-gray-100 text-gray-500"></div>
                    <div class="col-span-2"><label class="block text-sm font-bold text-gray-700">å‚™è¨»</label><textarea id="setting-note" rows="3" class="w-full border p-2 rounded" onchange="saveData()">1. å¦‚éœ€è«‹å‡æ™‚ï¼Œè«‹å‹™å¿…æ–¼ 16:00 å¾Œï¼Œä¸Šèª²æ•™å¸«å·²ç¶“åˆ°è©²ç­æ•™å®¤ä¸Šèª²æ‰èƒ½ç›´æ¥æ¥è½å®¶é•·æ‚¨çš„é›»è©±ã€‚
2. å¦‚æœæƒ³è¦æå‰å‘ŠçŸ¥ï¼Œè«‹æ’¥æ‰“ 3411373#112 ç”±è¨»å†Šçµ„å”åŠ©è½‰çŸ¥ä¸Šèª²æ•™å¸«ã€‚</textarea></div>
                    <div class="col-span-2"><label class="block text-sm font-bold text-gray-700">è‡´å®¶é•·ä¿¡</label><textarea id="setting-footer" rows="2" class="w-full border p-2 rounded" onchange="saveData()">å„ä½å®¶é•·æ‚¨å¥½ï¼š
å¾ˆæ­¡è¿å®¶é•·æ‚¨è®“å­¸ç”Ÿå ±åæœ¬æ¬¡å­¸ç¿’æ‰¶åŠ©èª²ç¨‹ï¼Œå¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œå†éº»ç…©æ‰“é›»è©±åˆ°æ•™å‹™è™•è¨»å†Šçµ„è©¢å•ï¼Œè¬è¬æ‚¨ã€‚</textarea></div>
                </div>
            </div>
            
            <div class="lg:col-span-1 space-y-3">
                <div class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">å ±è¡¨åŒ¯å‡º</div>
                <div class="border p-3 rounded hover:bg-green-50 cursor-pointer transition bg-white shadow-sm flex items-center" onclick="exportExcel()"><span class="text-2xl mr-3">ğŸ“Š</span><div><h3 class="font-bold text-green-700 text-sm">ä¸‹è¼‰ å­¸ç”Ÿç·¨ç­åå–®</h3></div></div>
                <div class="border p-3 rounded hover:bg-blue-50 cursor-pointer transition bg-white shadow-sm flex items-center" onclick="exportClassSettingsExcel()"><span class="text-2xl mr-3">ğŸ“‹</span><div><h3 class="font-bold text-blue-700 text-sm">ä¸‹è¼‰ ç­ç´šé–‹èª²ç¸½è¡¨</h3></div></div>
                <div class="border p-3 rounded hover:bg-pink-50 cursor-pointer transition bg-white shadow-sm flex items-center" onclick="exportRollCallExcel()"><span class="text-2xl mr-3">ğŸ“</span><div><h3 class="font-bold text-pink-700 text-sm">ä¸‹è¼‰ å„ç­é»åå–®</h3></div></div>
                <div class="border p-3 rounded hover:bg-purple-100 cursor-pointer transition bg-white shadow-sm flex items-center ring-2 ring-purple-500" onclick="preparePrint()"><span class="text-2xl mr-3">ğŸ–¨ï¸</span><div><h3 class="font-bold text-purple-700 text-sm">åˆ—å°é–‹èª²é€šçŸ¥å–®</h3></div></div>
                <div class="border border-dashed border-gray-300 p-3 rounded hover:bg-gray-50 cursor-pointer transition flex items-center text-gray-500" onclick="document.getElementById('importFile').click()"><span class="text-xl mr-3">ğŸ“‚</span><div><h3 class="font-bold text-sm">åƒ…åŒ¯å…¥å­¸ç”Ÿåå–®</h3></div><input type="file" id="importFile" accept=".xlsx, .xls" class="hidden" onchange="importExcel(this)"></div>
                <div class="mt-4 pt-4 border-t"><button onclick="resetSystem()" class="w-full text-center bg-red-50 text-red-600 border border-red-200 p-2 rounded hover:bg-red-100 text-xs font-bold">âš ï¸ é‡ç½®ç³»çµ±</button></div>
            </div>
        </div>
    </div>

    <div id="print-layout" class="print-area"></div>

    <script>
        let students = []; 
        let classes = [];
        // é è¨­æ“´å……è‡³ O ç­
        const defaultClasses = [
            { id: 'A', name: 'Aç­', grade: '3', subject: 'åœ‹èª', teacher: 'è€å¸«ä¸€', code: 'A302', floor: '3F-EåŒ–æ•™å®¤1', roomName: '3F-EåŒ–æ•™å®¤1', extension: '115' },
            { id: 'B', name: 'Bç­', grade: '4', subject: 'åœ‹èª', teacher: 'è€å¸«äºŒ', code: 'A204', floor: 'è‡³å–„æ¨“2F-1', roomName: '203', extension: '221' },
            { id: 'C', name: 'Cç­', grade: '2', subject: 'æ•¸å­¸', teacher: 'è€å¸«ä¸‰', code: 'A205', floor: 'è‡³å–„æ¨“2F-2', roomName: '204', extension: '222' },
            { id: 'D', name: 'Dç­', grade: '3', subject: 'æ•¸å­¸', teacher: 'è€å¸«å››', code: 'A206', floor: 'è‡³å–„æ¨“2F-3', roomName: '205', extension: '223' },
            { id: 'E', name: 'Eç­', grade: '5', subject: 'æ•¸å­¸', teacher: 'è€å¸«äº”', code: 'A207', floor: 'è‡³å–„æ¨“2F-4', roomName: '206', extension: '224' },
            { id: 'F', name: 'Fç­', grade: '5', subject: 'æ•¸å­¸', teacher: 'è€å¸«å…­', code: 'A208', floor: 'è‡³å–„æ¨“2F-5', roomName: '401', extension: '225' },
            { id: 'G', name: 'Gç­', grade: '6', subject: 'æ•¸å­¸', teacher: 'è€å¸«ä¸ƒ', code: 'A209', floor: 'è‡³å–„æ¨“2F-6', roomName: '402', extension: '226' },
            { id: 'H', name: 'Hç­', grade: '4', subject: 'è‹±èª', teacher: 'è€å¸«å…«', code: 'B305', floor: 'è‡³ç¾æ¨“3F-5', roomName: '505', extension: '335' },
            { id: 'I', name: 'Iç­', grade: '4', subject: 'è‹±èª', teacher: 'è€å¸«ä¹', code: 'A505', floor: 'è‡³å–„æ¨“5F-3', roomName: '5F-EåŒ–æ•™å®¤3', extension: '253' },
            { id: 'K', name: 'Kç­', grade: '6', subject: 'è‹±èª', teacher: 'è€å¸«å', code: 'B401', floor: 'è‡³ç¾æ¨“5F-1', roomName: '603', extension: '341' },
            { id: 'L', name: 'Lç­', grade: '', subject: 'åœ‹èª', teacher: 'è€å¸«åä¸€', code: '', floor: '', roomName: '', extension: '' },
            { id: 'M', name: 'Mç­', grade: '', subject: 'æ•¸å­¸', teacher: 'è€å¸«åäºŒ', code: '', floor: '', roomName: '', extension: '' },
            { id: 'N', name: 'Nç­', grade: '', subject: 'è‹±èª', teacher: 'è€å¸«åä¸‰', code: '', floor: '', roomName: '', extension: '' },
            { id: 'O', name: 'Oç­', grade: '', subject: 'åœ‹èª', teacher: 'è€å¸«åå››', code: '', floor: '', roomName: '', extension: '' }
        ];
        const defaultSubjects = ['åœ‹èª', 'æ•¸å­¸', 'è‹±èª'];
        const subjectColors = { 'åœ‹èª': 'bg-red-500', 'æ•¸å­¸': 'bg-blue-500', 'è‹±èª': 'bg-green-500', 'è‹±æ–‡': 'bg-green-500' };
        const subjectTextColors = { 'åœ‹èª': 'text-red-600', 'æ•¸å­¸': 'text-blue-600', 'è‹±èª': 'text-green-600', 'è‹±æ–‡': 'text-green-600' };
        const subjectBorderColors = { 'åœ‹èª': 'border-red-400', 'æ•¸å­¸': 'border-blue-400', 'è‹±èª': 'border-green-400', 'è‹±æ–‡': 'border-green-400' };

        window.onload = function() {
            loadData();
            renderScanList();
            renderClassSettings();
            loadSettingsToUI();
        }

        function loadData() {
            const savedStudents = localStorage.getItem('classSys_students');
            const savedClasses = localStorage.getItem('classSys_classes');
            students = savedStudents ? JSON.parse(savedStudents) : [];
            classes = savedClasses ? JSON.parse(savedClasses) : JSON.parse(JSON.stringify(defaultClasses));
        }

        function saveData() {
            localStorage.setItem('classSys_students', JSON.stringify(students));
            localStorage.setItem('classSys_classes', JSON.stringify(classes));
            const settings = {
                title: document.getElementById('setting-title').value,
                date: document.getElementById('setting-date').value,
                time: document.getElementById('setting-time').value,
                deadline: document.getElementById('setting-deadline').value,
                note: document.getElementById('setting-note').value,
                footer: document.getElementById('setting-footer').value
            };
            localStorage.setItem('classSys_settings', JSON.stringify(settings));
            const status = document.getElementById('save-status');
            status.innerText = '(å·²è‡ªå‹•å­˜æª”)';
            setTimeout(() => status.innerText = '', 2000);
        }

        function loadSettingsToUI() {
            const savedSettings = localStorage.getItem('classSys_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('setting-title').value = settings.title || '';
                document.getElementById('setting-date').value = settings.date || '';
                document.getElementById('setting-time').value = settings.time || '';
                document.getElementById('setting-deadline').value = settings.deadline || '';
                document.getElementById('setting-note').value = settings.note || '';
                document.getElementById('setting-footer').value = settings.footer || '';
            }
        }

        function manualAdd() {
            const grade = document.getElementById('mGrade').value;
            const cls = document.getElementById('mClass').value;
            const name = document.getElementById('mName').value;
            const checkboxes = document.querySelectorAll('input[name="mSub"]:checked');
            let selectedSubjects = [];
            checkboxes.forEach((cb) => selectedSubjects.push(cb.value));
            
            if(!name || !grade || !cls || selectedSubjects.length === 0) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šä¸¦å‹¾é¸ç­ç´š"); return; }
            students.push({ id: Date.now(), name, orgGrade: grade, orgClass: cls, subjects: selectedSubjects });
            document.getElementById('mName').value = '';
            document.querySelectorAll('input[name="mSub"]').forEach(el => el.checked = false);
            renderScanList();
            saveData(); 
        }

        function mockScanNewForm() {
            const newStudents = [
                { id: Date.now() + 1, name: 'å³æ˜Ÿæ¾„', orgGrade: '2', orgClass: '1', subjects: ['æ•¸å­¸'] },
                { id: Date.now() + 2, name: 'æ—å°è±ª', orgGrade: '4', orgClass: '1', subjects: ['åœ‹èª', 'æ•¸å­¸'] },
                { id: Date.now() + 3, name: 'å¼µé›…å©·', orgGrade: '3', orgClass: '2', subjects: ['è‹±èª'] }
            ];
            students = [...students, ...newStudents];
            renderScanList();
            saveData(); 
        }

        function deleteStudent(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ')) return;
            students = students.filter(s => s.id !== id);
            renderScanList();
            saveData();
        }

        function openEditModal(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            document.getElementById('edit-id').value = student.id;
            document.getElementById('edit-grade').value = student.orgGrade;
            document.getElementById('edit-class').value = student.orgClass;
            document.getElementById('edit-name').value = student.name;
            document.getElementById('edit-sub-chi').checked = student.subjects.includes('åœ‹èª');
            document.getElementById('edit-sub-math').checked = student.subjects.includes('æ•¸å­¸');
            document.getElementById('edit-sub-eng').checked = student.subjects.includes('è‹±èª') || student.subjects.includes('è‹±æ–‡');
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        function saveEdit() {
            const id = parseInt(document.getElementById('edit-id').value);
            const student = students.find(s => s.id === id);
            if (!student) return;
            student.orgGrade = document.getElementById('edit-grade').value;
            student.orgClass = document.getElementById('edit-class').value;
            student.name = document.getElementById('edit-name').value;
            const newSubjects = [];
            if(document.getElementById('edit-sub-chi').checked) newSubjects.push('åœ‹èª');
            if(document.getElementById('edit-sub-math').checked) newSubjects.push('æ•¸å­¸');
            if(document.getElementById('edit-sub-eng').checked) newSubjects.push('è‹±èª');
            if(newSubjects.length === 0) { alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç§‘ç›®'); return; }
            student.subjects = newSubjects;
            closeEditModal();
            renderScanList();
            saveData();
        }

        function sortRegisteredList() {
            students.sort((a, b) => {
                const gA = parseInt(a.orgGrade) || 0; const gB = parseInt(b.orgGrade) || 0;
                if(gA !== gB) return gA - gB;
                const cA = parseInt(a.orgClass) || 0; const cB = parseInt(b.orgClass) || 0;
                return cA - cB;
            });
            renderScanList();
            saveData();
        }

        function renderScanList() {
            const container = document.getElementById('scanned-list');
            document.getElementById('count-badge').innerText = `${students.length} äºº`;
            container.innerHTML = students.length === 0 ? '<p class="text-gray-400 text-center mt-20">è«‹åœ¨å·¦å´è¼¸å…¥å›æ¢è³‡æ–™</p>' : 
            students.map(s => `
                <div class="scan-item flex justify-between items-center bg-white p-3 mb-1 border rounded shadow-sm cursor-pointer transition" ondblclick="openEditModal(${s.id})" title="é»å…©ä¸‹å¯ç·¨è¼¯">
                    <div class="flex items-center"><span class="bg-gray-200 text-gray-700 font-bold px-2 py-1 rounded text-xs mr-3">${s.orgGrade}å¹´${s.orgClass}ç­</span><span class="font-bold text-gray-800">${s.name}</span></div>
                    <div class="flex items-center gap-2"><div class="flex gap-1">${s.subjects.map(sub => `<span class="text-xs text-white px-2 py-1 rounded ${subjectColors[sub] || 'bg-gray-400'}">${sub}</span>`).join('')}</div><button onclick="deleteStudent(${s.id})" class="text-red-400 hover:text-red-600 font-bold px-2 text-lg">Ã—</button></div>
                </div>
            `).join('');
        }

        function renderClassSettings() {
            const tbody = document.getElementById('class-settings-tbody');
            tbody.innerHTML = classes.map((c, index) => {
                const textColor = subjectTextColors[c.subject] || '';
                return `<tr>
                    <td><input type="text" value="${c.name}" onchange="updateClassByIndex(${index}, 'name', this.value)" placeholder="Aç­"></td>
                    <td><input type="number" value="${c.grade}" onchange="updateClassByIndex(${index}, 'grade', this.value)" placeholder="3"></td>
                    <td><select onchange="updateClassByIndex(${index}, 'subject', this.value)" class="font-bold ${textColor}"><option value="åœ‹èª" ${c.subject === 'åœ‹èª' ? 'selected' : ''} class="text-red-600 font-bold">åœ‹èª</option><option value="æ•¸å­¸" ${c.subject === 'æ•¸å­¸' ? 'selected' : ''} class="text-blue-600 font-bold">æ•¸å­¸</option><option value="è‹±èª" ${c.subject === 'è‹±èª' ? 'selected' : ''} class="text-green-600 font-bold">è‹±èª</option></select></td>
                    <td><input type="text" value="${c.teacher}" onchange="updateClassByIndex(${index}, 'teacher', this.value)"></td>
                    <td><input type="text" value="${c.extension}" onchange="updateClassByIndex(${index}, 'extension', this.value)"></td>
                    <td><input type="text" value="${c.code}" onchange="updateClassByIndex(${index}, 'code', this.value)" placeholder="A302"></td>
                    <td><input type="text" value="${c.floor}" onchange="updateClassByIndex(${index}, 'floor', this.value)" placeholder="3F-EåŒ–"></td>
                    <td><input type="text" value="${c.roomName}" onchange="updateClassByIndex(${index}, 'roomName', this.value)" placeholder="æ•™å®¤å"></td>
                    <td class="text-center"><button onclick="deleteClassByIndex(${index})" class="text-red-500 hover:text-red-700 font-bold">åˆªé™¤</button></td>
                </tr>`
            }).join('');
        }

        function updateClassByIndex(index, field, value) { classes[index][field] = value; saveData(); if(field === 'subject') renderClassSettings(); }
        function addNewClassRow() { const nextCode = String.fromCharCode(65 + classes.length); classes.push({ id: Date.now().toString(), name: nextCode + 'ç­', grade: '', subject: 'åœ‹èª', teacher: '', code: '', floor: '', roomName: '', extension: '' }); renderClassSettings(); saveData(); }
        function deleteClassByIndex(index) { if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­ç´šï¼Ÿ")) return; const classId = classes[index].id; students.forEach(s => { if(s.classId === classId) s.classId = null; }); classes.splice(index, 1); renderClassSettings(); saveData(); }

        function toggleSubject(classId) {
            const cls = classes.find(c => c.id === classId); if(!cls) return;
            let idx = defaultSubjects.indexOf(cls.subject); if(idx === -1) idx = 0;
            const nextIdx = (idx + 1) % defaultSubjects.length; cls.subject = defaultSubjects[nextIdx];
            renderDragBoard(); saveData();
        }
        function updateClassGradeDirect(classId, value) { const cls = classes.find(c => c.id === classId); if(!cls) return; cls.grade = value; saveData(); }

        function renderDragBoard() {
            const pool = document.getElementById('unassigned-pool'); pool.innerHTML = '';
            const classOptions = `<option value="">è«‹é¸æ“‡ç­ç´š...</option>` + classes.map(c => `<option value="${c.id}">${c.name} (${c.grade}å¹´-${c.subject})</option>`).join('');
            students.forEach(s => { if(!s.classId) createStudentCard(s, pool, true, classOptions); });
            if(!pool.sortable) pool.sortable = new Sortable(pool, { group: 'shared', animation: 150, 
                onAdd: function (evt) {
                    const studentId = evt.item.dataset.id;
                    const newClassId = this.el.dataset.classId; 
                    const s = students.find(x => x.id == studentId);
                    if(s) s.classId = (newClassId === 'null') ? null : newClassId;
                    if (newClassId === 'null') { renderDragBoard(); return; }
                    else { const select = evt.item.querySelector('.quick-assign-select'); if(select) select.remove(); }
                    classes.forEach(c => updateClassCountDisplay(c.id)); saveData();
                } 
            });

            const classContainer = document.getElementById('classes-container'); classContainer.innerHTML = '';
            classes.forEach(cls => {
                const col = document.createElement('div');
                col.className = "flex flex-col bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden h-[400px]"; col.dataset.id = cls.id;
                const subColor = subjectColors[cls.subject] || 'bg-gray-400'; const subTextColor = subjectTextColors[cls.subject] || 'text-gray-600';
                col.innerHTML = `<div class="p-3 border-b bg-gray-50 flex-shrink-0"><div class="flex justify-between items-center mb-1"><div class="flex items-center"><span class="class-drag-handle text-xl mr-1" title="æŒ‰ä½æ‹–æ›³å¯äº’æ›ç­ç´šé †åº">âœ¥</span><span class="text-xl font-bold text-gray-800 mr-1">${cls.name}</span><div class="flex items-center bg-gray-100 rounded px-1 border border-gray-300"><input type="number" value="${cls.grade}" onchange="updateClassGradeDirect('${cls.id}', this.value)" class="w-6 bg-transparent text-center font-bold text-sm focus:outline-none p-0" placeholder="?"><span class="text-xs text-gray-500 font-bold ml-0.5">å¹´ç´š</span></div></div><div class="cursor-pointer flex items-center gap-1 px-2 py-1 rounded-full border ${subTextColor} border-current bg-white hover:bg-gray-50 transition select-none" onclick="toggleSubject('${cls.id}')" title="é»æ“Šåˆ‡æ›ç§‘ç›®"><span class="w-2.5 h-2.5 rounded-full ${subColor}"></span><span class="text-xs font-bold">${cls.subject}</span></div></div></div><div id="class-${cls.id}" class="flex-1 p-2 overflow-y-auto bg-white relative" data-class-id="${cls.id}"></div><div class="p-2 border-t bg-gray-50 text-center text-xs font-bold text-gray-500 flex-shrink-0"><span id="count-${cls.id}">0</span> äºº</div>`;
                classContainer.appendChild(col);
                const classBody = col.querySelector(`#class-${cls.id}`);
                students.filter(s => s.classId === cls.id).forEach(s => createStudentCard(s, classBody));
                col.querySelector(`#count-${cls.id}`).innerText = `${students.filter(s => s.classId === cls.id).length}`;
                new Sortable(classBody, { group: 'shared', animation: 150, onAdd: function (evt) {
                    const studentId = evt.item.dataset.id; const newClassId = this.el.dataset.classId; 
                    const s = students.find(x => x.id == studentId); if(s) s.classId = newClassId;
                    const select = evt.item.querySelector('.quick-assign-select'); if(select) select.remove();
                    setTimeout(() => updateClassCountDisplay(cls.id), 50); saveData();
                }});
            });
            new Sortable(classContainer, { handle: '.class-drag-handle', animation: 150, onEnd: function (evt) { reorderClasses(evt.oldIndex, evt.newIndex); } });
        }

        function reorderClasses(oldIndex, newIndex) {
            if (oldIndex === newIndex) return;
            const movedClass = classes.splice(oldIndex, 1)[0]; classes.splice(newIndex, 0, movedClass);
            classes.forEach((cls, index) => { const newCode = String.fromCharCode(65 + index); cls.name = `${newCode}ç­`; });
            saveData(); renderDragBoard(); renderClassSettings(); 
        }

        function sortPool(criteria) {
            if (criteria === 'grade') { students.sort((a, b) => (parseInt(a.orgGrade || 0) - parseInt(b.orgGrade || 0)) || (parseInt(a.orgClass || 0) - parseInt(b.orgClass || 0))); } 
            else if (criteria === 'subject') { const w = { 'åœ‹èª': 1, 'æ•¸å­¸': 2, 'è‹±èª': 3 }; students.sort((a, b) => (w[a.subjects[0]] || 9) - (w[b.subjects[0]] || 9)); }
            renderDragBoard();
        }

        function createStudentCard(student, container, showSelect = false, optionsHtml = '') {
            const div = document.createElement('div'); const mainSubject = student.subjects[0] || 'å…¶ä»–';
            div.className = `student-card ${subjectBorderColors[mainSubject] || 'border-gray-300'}`; div.dataset.id = student.id;
            let dots = student.subjects.map(sub => `<span class="dot ${subjectColors[sub] || 'bg-gray-400'}" title="${sub}"></span>`).join('');
            let selectHtml = showSelect ? `<select class="quick-assign-select" onchange="updateStudentClass(${student.id}, this.value)">${optionsHtml}</select>` : '';
            div.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="font-bold text-gray-800">${student.name}</span><div class="flex pt-1">${dots}</div></div><div class="student-meta"><span>${student.orgGrade}å¹´${student.orgClass}ç­</span></div>${selectHtml}`;
            container.appendChild(div);
        }

        function updateStudentClass(sid, cid) {
            const s = students.find(x => x.id == sid); if(s) s.classId = cid;
            classes.forEach(c => updateClassCountDisplay(c.id));
            renderDragBoard(); saveData();
        }
        function updateClassCountDisplay(classId) {
            const count = students.filter(s => s.classId === classId).length;
            const el = document.getElementById(`count-${classId}`); if(el) el.innerText = `${count}`;
        }

        function updatePreview() {
            const preview = document.getElementById('data-preview');
            const summary = classes.map(c => { const count = students.filter(s => s.classId === c.id).length; return `[${c.name}] (${c.subject}) ${c.teacher} : ${count}äºº`; }).join('\n');
            preview.innerText = summary || 'å°šç„¡ç­ç´šæ•¸æ“š';
        }

        function toChineseNum(num) { const map = {'1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹'}; return map[num] || num; }
        function exportClassSettingsExcel() { const data = classes.map(c => { const classCode = c.name.replace('ç­', ''); const gradeChi = toChineseNum(c.grade); const fullCode = `${classCode}-${gradeChi}-${c.subject}`; return { "ç­åˆ¥": classCode, "å¹´ç´š": c.grade, "ç§‘ç›®": c.subject, "ä»£è™Ÿ": fullCode, "æ•™å¸«å§“å": c.teacher, "æ•™å®¤": c.code, "æ¨“-é–“": c.floor, "é›»è©±": c.extension, "æ•™å®¤åç¨±": c.roomName }; }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ç­ç´šæ•™å¸«ç¸½è¡¨"); XLSX.writeFile(wb, "ç­ç´šé–‹èª²ç¸½è¡¨.xlsx"); }
        function exportExcel() { const data = students.map(s => { const cls = classes.find(c => c.id === s.classId) || {}; return { "åŸå¹´ç´š": s.orgGrade, "åŸç­ç´š": s.orgClass, "å­¸ç”Ÿå§“å": s.name, "å ±åæ„é¡˜": s.subjects.join(','), "åˆ†ç™¼ç­ç´š": cls.name || 'æœªåˆ†ç™¼', "å¹´ç´š": cls.grade || '', "ç§‘ç›®": cls.subject || '', "æˆèª²æ•™å¸«": cls.teacher || '', "åˆ†æ©Ÿ": cls.extension || '', "æ•™å®¤åç¨±": cls.roomName || '', "æ•™å®¤ä»£è™Ÿ": cls.code || '', "æ¨“å±¤": cls.floor || '' }; }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ç·¨ç­çµæœ"); XLSX.writeFile(wb, "å­¸ç¿’æ‰¶åŠ©ç·¨ç­åå–®.xlsx"); }
        function exportRollCallExcel() { const wb = XLSX.utils.book_new(); let hasData = false; classes.forEach(cls => { const classStudents = students.filter(s => s.classId === cls.id); if (classStudents.length > 0) { hasData = true; classStudents.sort((a, b) => (parseInt(a.orgGrade || 0) - parseInt(b.orgGrade || 0)) || (parseInt(a.orgClass || 0) - parseInt(b.orgClass || 0))); const sheetData = classStudents.map((s, i) => ({ "åº§è™Ÿ": i + 1, "åŸç­ç´š": `${s.orgGrade}å¹´${s.orgClass}ç­`, "å­¸ç”Ÿå§“å": s.name, "ç§‘ç›®": s.subjects.join('/'), "ç¬¬1é€±": "", "ç¬¬2é€±": "", "ç¬¬3é€±": "", "ç¬¬4é€±": "", "ç¬¬5é€±": "", "ç¬¬6é€±": "", "ç¬¬7é€±": "", "ç¬¬8é€±": "", "å‚™è¨»": "" })); const ws = XLSX.utils.json_to_sheet(sheetData); XLSX.utils.book_append_sheet(wb, ws, `${cls.name}`); } }); if (!hasData) { alert("ç›®å‰æ²’æœ‰å·²åˆ†ç™¼åˆ°ç­ç´šçš„å­¸ç”Ÿ"); return; } XLSX.writeFile(wb, "å„ç­å­¸ç”Ÿé»åå–®.xlsx"); }
        function importExcel(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet); if (jsonData.length === 0) { alert("æª”æ¡ˆä¼¼ä¹æ˜¯ç©ºçš„"); return; } if(!confirm(`å³å°‡åŒ¯å…¥ ${jsonData.length} ç­†è³‡æ–™ï¼Œé€™å°‡æœƒæ¸…é™¤ç›®å‰çš„å­¸ç”Ÿåå–®ä¸¦è¦†è“‹ã€‚ç¢ºå®šå—ï¼Ÿ`)) { input.value = ''; return; } students = []; jsonData.forEach((row, index) => { const name = row['å­¸ç”Ÿå§“å'] || row['å§“å']; const grade = row['åŸå¹´ç´š']; const cls = row['åŸç­ç´š']; const subjectsStr = row['å ±åæ„é¡˜'] || row['å ±åç§‘ç›®'] || ''; const assignedClassName = row['åˆ†ç™¼ç­ç´š']; let subArr = []; if(subjectsStr) subArr = subjectsStr.split(/[,ï¼Œã€/]/).map(s => s.trim()).filter(s => s); let classId = null; if(assignedClassName && assignedClassName !== 'æœªåˆ†ç™¼') { const matchedClass = classes.find(c => c.name === assignedClassName || assignedClassName.includes(c.name)); if(matchedClass) classId = matchedClass.id; } if(name) { students.push({ id: Date.now() + index, name: name, orgGrade: grade || '', orgClass: cls || '', subjects: subArr, classId: classId }); } }); alert(`æˆåŠŸåŒ¯å…¥ ${students.length} ç­†å­¸ç”Ÿè³‡æ–™ï¼`); input.value = ''; renderScanList(); renderDragBoard(); updatePreview(); saveData(); }; reader.readAsArrayBuffer(file); }
        function exportSystemBackup() { const settings = { title: document.getElementById('setting-title').value, date: document.getElementById('setting-date').value, time: document.getElementById('setting-time').value, deadline: document.getElementById('setting-deadline').value, note: document.getElementById('setting-note').value, footer: document.getElementById('setting-footer').value }; const backupData = { version: "15.0", timestamp: new Date().toISOString(), students, classes, settings }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `ç·¨ç­ç³»çµ±å®Œæ•´å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        function importSystemBackup(input) { const file = input.files[0]; if (!file) return; if(!confirm("âš ï¸ è­¦å‘Šï¼šé‚„åŸå‚™ä»½å°‡æœƒã€Œè¦†è“‹ã€ç›®å‰é€™å°é›»è…¦ä¸Šçš„æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) { input.value = ''; return; } const reader = new FileReader(); reader.onload = function(e) { try { const backupData = JSON.parse(e.target.result); students = backupData.students; classes = backupData.classes; localStorage.setItem('classSys_students', JSON.stringify(students)); localStorage.setItem('classSys_classes', JSON.stringify(classes)); if (backupData.settings) localStorage.setItem('classSys_settings', JSON.stringify(backupData.settings)); alert("âœ… ç³»çµ±è³‡æ–™é‚„åŸæˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†..."); location.reload(); } catch (err) { alert("âŒ é‚„åŸå¤±æ•—ï¼š" + err.message); } input.value = ''; }; reader.readAsText(file); }
        function resetSystem() { if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™å°‡æœƒåˆªé™¤æ‰€æœ‰å­¸ç”Ÿåå–®ã€ç­ç´šè¨­å®šèˆ‡é€šçŸ¥å–®å…§å®¹ï¼Œä¸”ç„¡æ³•å¾©åŸï¼")) { localStorage.removeItem('classSys_students'); localStorage.removeItem('classSys_classes'); localStorage.removeItem('classSys_settings'); location.reload(); } }
        function preparePrint() { const container = document.getElementById('print-layout'); container.innerHTML = ''; const assignedStudents = students.filter(s => s.classId); const settings = { title: document.getElementById('setting-title').value, date: document.getElementById('setting-date').value, time: document.getElementById('setting-time').value, deadline: document.getElementById('setting-deadline').value, note: document.getElementById('setting-note').value.replace(/\n/g, '<br>'), footer: document.getElementById('setting-footer').value.replace(/\n/g, '<p>') }; if(assignedStudents.length === 0) { alert("ç›®å‰æ²’æœ‰å­¸ç”Ÿè¢«åˆ†é…åˆ°ç­ç´šï¼Œç„¡æ³•åˆ—å°é€šçŸ¥å–®ã€‚"); return; } assignedStudents.forEach((s) => { const cls = classes.find(c => c.id === s.classId); const extStr = cls.extension ? `3411373#${cls.extension}` : '(æœªè¨­å®š)'; const fullClassName = `${cls.name} (${cls.grade}å¹´ç´š ${cls.subject})`; let roomDisplay = cls.roomName || ''; if (cls.code) roomDisplay += ` (${cls.code})`; if (cls.floor) roomDisplay += ` - ${cls.floor}`; const html = generateNoticeHTML(s, cls, settings, extStr, fullClassName, roomDisplay); const page = document.createElement('div'); page.className = 'page-break'; page.innerHTML = html; container.appendChild(page); }); window.print(); }
        function generateNoticeHTML(student, cls, settings, extStr, fullClassName, roomDisplay) { return `<div class="notice-box"><div class="notice-header">${settings.title}</div><table style="width:100%; border-collapse: collapse; margin-bottom: 10px; font-size: 18px;"><tr><td style="padding: 5px;">ç­ç´šï¼š<strong>${student.orgGrade}å¹´ ${student.orgClass}ç­</strong></td><td style="padding: 5px; text-align:right;">å­¸ç”Ÿå§“åï¼š<strong>${student.name}</strong></td></tr></table><div style="border: 1px solid black; padding: 15px; margin-bottom: 15px;"><p>ä¸Šèª²ç­ç´šï¼š<strong>${fullClassName}</strong></p><p>ä¸Šèª²æ—¥æœŸï¼š${settings.date}</p><p>ä¸Šèª²æ™‚é–“ï¼š<strong>${settings.time}</strong></p><p>ä¸Šèª²æ•™å¸«ï¼š${cls.teacher} è€å¸«</p><p>ä¸Šèª²æ•™å®¤ï¼š${roomDisplay}</p><p>æ•™å®¤åˆ†æ©Ÿï¼š${extStr}</p><br><p>å‚™è¨»ï¼š</p><div style="padding-left: 20px;">${settings.note}</div></div><div class="mb-4">${settings.footer}</div><div class="cut-line"><span>è«‹æ²¿ç·šå‰ªä¸‹ç¹³äº¤çµ¦ä»»èª²è€å¸«æ–¹ä¾¿å”åŠ©è¯çµ¡---ä¸Šæ–¹è³‡æ–™å®¶é•·è‡ªè¡Œç•™å­˜</span></div><div style="border: 2px solid black; padding: 10px; text-align: center; margin: 20px 0;"><h3 style="margin:0;">å› æ¢ ${settings.deadline} äº¤äºˆæˆèª²å­¸æ‰¶æ•™å¸«</h3></div><div style="text-align: center; margin-bottom: 10px; font-size: 18px;"><span>${student.orgGrade}å¹´${student.orgClass}ç­ ${student.name}</span></div><div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>ä¸Šèª²ç­ç´šï¼š${fullClassName}</span><span>ä¸Šèª²æ•™å¸«ï¼š${cls.teacher}</span></div><div style="text-align: center; font-weight: bold; margin-bottom: 15px;">â€»å­¸ç¿’æ‰¶åŠ©èª²å¾Œæ¥é€è€…(è«‹å‹™å¿…å¡«å¯«ä¸¦ç¹³äº¤ï¼Œä»¥åˆ©ç¢ºèªå­¸ç”Ÿå®‰å…¨)</div><div style="line-height: 2.2; font-size: 16px;"><div>â–¡ å®¶äººï¼Œç¨±è¬‚(ã€€ã€€ã€€ã€€)ï¼Œé€£çµ¡é›»è©±(ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€)</div><div>â–¡ æ ¡å¤–å®‰è¦ªç­_åç¨±(ã€€ã€€ã€€ã€€)ï¼Œé€£çµ¡é›»è©±(ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€)</div><div>â–¡ æ ¡å…§å®‰è¦ªç­è€å¸«é›»è©±æˆ–æ•™å®¤åˆ†æ©Ÿ(ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€)</div><div>â–¡ å…¶ä»–ï¼Œè«‹èªªæ˜(ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€)</div></div><div style="margin-top: 30px; text-align: right; font-size: 16px;">å®¶é•·ç°½å ______________________</div></div>`; }
        function switchTab(tab) { document.querySelectorAll('.show-section').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.show-section').forEach(el => el.classList.remove('show-section')); document.getElementById('scan-section').classList.add('hidden'); document.getElementById('class-settings-section').classList.add('hidden'); document.getElementById('class-settings-section').classList.remove('flex'); document.getElementById('arrange-section').classList.add('hidden'); document.getElementById('arrange-section').classList.remove('flex'); document.getElementById('print-section').classList.add('hidden'); if(tab === 'scan') document.getElementById('scan-section').classList.remove('hidden'); if(tab === 'class-settings') { document.getElementById('class-settings-section').classList.remove('hidden'); document.getElementById('class-settings-section').classList.add('flex'); renderClassSettings(); } if(tab === 'arrange') { document.getElementById('arrange-section').classList.remove('hidden'); document.getElementById('arrange-section').classList.add('flex'); renderDragBoard(); } if(tab === 'print') { document.getElementById('print-section').classList.remove('hidden'); updatePreview(); } }
    </script>
</body>
</html>
